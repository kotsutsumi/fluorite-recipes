# Drainsの使用

## 概要

DrainsはEnterpriseおよびProプランで利用可能な機能で、開発者は以下が可能です：

- 可観測性データを外部サービスに転送
- テレメトリデータを永続的に保存
- 大量のデータを処理
- カスタムメトリクスとダッシュボードを構築

## Drainsの開始方法

### 設定方法

**1. カスタムエンドポイント**
- 任意のHTTPエンドポイントにデータを送信

**2. ネイティブ統合**
- Dash0やBraintrustなどの特定のサービスにログとトレースデータを送信

## データタイプ

Drainsは4つのデータタイプをサポート：

1. **Logs**: ログ（ランタイム、ビルド、静的）
2. **Traces**: トレース（OpenTelemetry形式）
3. **Speed Insights**: Speed Insightsデータ
4. **Web Analytics**: Web Analyticsデータ

### データタイプリファレンス

各データタイプには、個別のリファレンスドキュメントで詳細な形式とスキーマがあります。

## セキュリティ

- 署名の検証
- IPアドレスの非表示
- 詳細なセキュリティ設定が利用可能

## 使用量と料金

- ProおよびEnterpriseプランで利用可能
- 料金: **$0.50 per 1 GB のデータ**

## Drainsの用途

### ログの長期保存

- Vercelのデフォルト保持期間を超えてログを保存
- 外部ロギングサービスと統合
- コンプライアンス要件を満たす

### カスタム分析

- 独自の分析ツールにデータを送信
- カスタムダッシュボードを構築
- ビジネス固有のメトリクスを追跡

### 統合されたモニタリング

- 既存の可観測性スタックと統合
- 複数のソースからのデータを一元化
- 統一されたビューを作成

## サポートされているログソース

- **Functions**: Vercel Functions
- **Edge Functions**: エッジFunction
- **Static Files**: 静的ファイル
- **Rewrites**: リライト
- **Builds**: ビルド
- **Firewall**: ファイアウォール

## 配信先のタイプ

### カスタムエンドポイント

- HTTPエンドポイントURLの設定
- データ形式の選択（JSON/NDJSON/Protobuf）
- オプションの署名検証
- カスタムヘッダーの追加

### ネイティブ統合

- ログとトレースデータ用のマーケットプレイス統合を使用
- インストール済みまたは利用可能な製品を選択

## 主な機能

### 自動相関

- ログとトレースの自動相関
- トレースされたリクエスト中のユーザーコードログに適用

### サンプリングレート制御

- データ量の管理
- コストの最適化
- フレキシブルなサンプリング設定

### 複数の環境サポート

- Production環境
- Preview環境
- 環境ごとの設定

## 使用例

### 外部ロギングシステムとの統合

1. カスタムエンドポイントDrainを作成
2. ロギングサービスのURLを設定
3. ログソースを選択
4. サンプリングレートを設定

### トレースデータのAPMツールへの送信

1. トレースDrainを設定
2. APMツールの統合を選択
3. プロジェクトとEnvironmentを選択
4. 接続をテスト

### コンプライアンスのためのログアーカイブ

1. ログDrainを設定
2. 長期ストレージエンドポイントを指定
3. すべてのログソースを含める
4. 100%のサンプリングレートを使用

## ベストプラクティス

### エンドポイントの設定

- 200 OKステータスで応答する必要がある
- レート制限を適切に処理
- エラーハンドリングを実装

### セキュリティ

- 署名検証を使用
- HTTPS接続のみ
- 機密データを保護

### パフォーマンス

- 適切なサンプリングレートを設定
- データフォーマットを最適化
- エンドポイントのパフォーマンスを監視

## 制限事項

- ProおよびEnterpriseプランでのみ利用可能
- 相関はトレースされたリクエスト中のユーザーコードログにのみ適用

## Drainsの管理

### 一時停止/再開

- 必要に応じてDrainsを一時停止
- データ収集を中断せずに再開

### 削除

- 不要になったDrainsを削除
- 設定の簡単なクリーンアップ

### テスト

- エンドポイント接続をテスト
- データフローを検証
- 問題を早期に特定

## データ形式

### JSON

- 読みやすい形式
- デバッグが簡単
- 多くのツールでサポート

### NDJSON

- 改行区切りJSON
- ストリーミングに適している
- 大量のデータに最適

### Protobuf

- バイナリ形式
- 高効率
- 大量のトレースデータに最適

## トラブルシューティング

### データが送信されない

- エンドポイント設定を確認
- サンプリングレートを確認
- ネットワーク接続を検証

### 部分的なデータ

- ログソースの選択を確認
- フィルタ設定を見直し
- エンドポイントのレート制限を確認

## 次のステップ

- [Drainsの設定](/docs/drains/using-drains)
- [ログDrainsリファレンス](/docs/drains/reference/logs)
- [トレースDrainsリファレンス](/docs/drains/reference/traces)
- [Speed Insightsリファレンス](/docs/drains/reference/speed-insights)
- [Analyticsリファレンス](/docs/drains/reference/analytics)
- [Drainsセキュリティ](/docs/drains/security)

## 関連リソース

- [可観測性](/docs/observability)
- [ログ](/docs/logs)
- [OpenTelemetry](/docs/otel)
- [料金プラン](/docs/pricing)
