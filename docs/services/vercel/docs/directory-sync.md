# ディレクトリ同期 (Directory Sync)

## 概要

ディレクトリ同期（Directory Sync）は、サードパーティのIDプロバイダー（Google Directory、Oktaなど）と組織のメンバーシップを自動的に同期する機能です。

### 対象プラン

- **エンタープライズプランでのみ利用可能**

### 必要な権限

- [所有者ロール](/docs/rbac/access-roles#owner-role)を持つユーザーのみアクセス可能

## 主な特徴

### 自動同期

ディレクトリプロバイダーの変更が自動的にVercelチームに同期されます：

- **ユーザーの追加**: 新しいユーザーが自動的にチームに追加
- **ユーザーの削除**: 削除されたユーザーが自動的にチームから削除
- **グループの更新**: グループメンバーシップの変更が反映

### 権限の上書き

- ディレクトリ同期が有効な場合、既存の権限/ロールは上書きされます
- ディレクトリグループに基づいてロールが自動的に割り当てられます

### グループマッピング

ディレクトリグループとVercelチームロールをマッピングできます：

- **Owner（所有者）**
- **Member（メンバー）**
- **Developer（開発者）**
- **Billing（請求）**
- **Viewer（閲覧者）**
- **Contributor（貢献者）**

## 設定手順

### 前提条件

1. **SAML SSOの設定**: ディレクトリ同期を使用する前に、SAML SSOを設定する必要があります
2. **エンタープライズプラン**: エンタープライズプランへの加入
3. **所有者権限**: チームの所有者ロールが必要

### 設定プロセス

#### 1. SAML SSOの設定

ディレクトリ同期を使用する前に、SAML SSOを設定します：

1. チームダッシュボードから「設定」タブを選択
2. 「セキュリティとプライバシー」に移動
3. SAML シングルサインオンの「設定」ボタンをクリック
4. 設定ウィザードに従ってSAML SSOを設定

詳細は[SAMLドキュメント](/docs/saml)を参照してください。

#### 2. ディレクトリ同期の有効化

1. SAML SSO設定が完了後、同じページに「ディレクトリ同期」セクションが表示されます
2. 「ディレクトリ同期を有効化」ボタンをクリック
3. ディレクトリプロバイダーを選択：
   - Google Workspace
   - Okta
   - Azure AD
   - その他のSCIMプロバイダー
4. プロバイダー固有の設定手順に従う

#### 3. グループマッピングの設定

ディレクトリグループとVercelロールをマッピング：

1. 「グループマッピング」タブに移動
2. 「マッピングを追加」をクリック
3. ディレクトリグループを選択
4. 対応するVercelロールを選択
5. 「保存」をクリック

#### 4. 同期の確認

1. 「同期状態」タブで同期ステータスを確認
2. 「今すぐ同期」ボタンをクリックして手動同期をトリガー
3. チームメンバーリストで変更を確認

## アカウントロックアウトの防止

### 予約済みグループ名

特定のグループ名を使用して、自動的にロールを割り当てることができます：

| グループ名 | 割り当てられるロール |
|-----------|-------------------|
| `vercel-role-owner` | Owner（所有者） |
| `vercel-role-member` | Member（メンバー） |
| `vercel-role-developer` | Developer（開発者） |
| `vercel-role-billing` | Billing（請求） |
| `vercel-role-viewer` | Viewer（閲覧者） |
| `vercel-role-contributor` | Contributor（貢献者） |

### ベストプラクティス

1. **常に所有者グループを作成**: 少なくとも1つの`vercel-role-owner`グループを作成
2. **複数の所有者**: 複数のユーザーを所有者グループに追加してロックアウトを防止
3. **テストアカウント**: 設定変更前にテストアカウントで確認

## サポートされているプロバイダー

### SCIM 2.0対応プロバイダー

Vercelは、SCIM 2.0プロトコルをサポートするすべてのIDプロバイダーと統合できます：

#### 主要プロバイダー

- **Google Workspace**: Google Directory
- **Okta**: Okta Directory
- **Azure AD**: Microsoft Azure Active Directory
- **OneLogin**: OneLogin Directory
- **JumpCloud**: JumpCloud Directory

#### その他のプロバイダー

以下のプロバイダーもサポートされています：

- Rippling
- Workday
- PingIdentity
- Auth0
- その他のSCIM 2.0互換プロバイダー

### プロバイダー固有の設定

各プロバイダーには固有の設定手順があります。詳細は、Vercelダッシュボードの設定ウィザードを参照してください。

## 同期される情報

### ユーザー情報

- **名前**: ユーザーの表示名
- **メールアドレス**: プライマリメールアドレス
- **ユーザーID**: 一意の識別子
- **グループメンバーシップ**: 所属するグループ

### グループ情報

- **グループ名**: グループの名前
- **グループID**: 一意の識別子
- **メンバー**: グループに所属するユーザー

### 同期されない情報

- ユーザーのアバター画像
- カスタム属性
- ネストされたグループ階層

## 同期のタイミング

### 自動同期

ディレクトリプロバイダーでの変更は、以下のタイミングで自動的に同期されます：

- **リアルタイム**: プロバイダーによってはほぼリアルタイムで同期
- **定期的**: 15分〜1時間ごとに自動同期（プロバイダーによる）
- **イベントトリガー**: ユーザーやグループの変更時に即座に同期

### 手動同期

ダッシュボードから手動で同期をトリガーできます：

1. 「ディレクトリ同期」設定に移動
2. 「今すぐ同期」ボタンをクリック
3. 同期の完了を待つ

## ユースケース

### 1. 大規模チームの自動管理

**シナリオ**: 100人以上のエンジニアを持つ企業

```
メリット:
- 新入社員が自動的にVercelに追加される
- 退職者が自動的に削除される
- 手動でのユーザー管理が不要
```

### 2. 部門ベースのアクセス制御

**シナリオ**: 部門ごとに異なるアクセスレベル

```
グループマッピング:
- engineering-team → Developer
- design-team → Viewer
- management-team → Member
```

### 3. プロジェクトベースのアクセス

**シナリオ**: プロジェクトごとにチームを構成

```
グループマッピング:
- project-alpha-team → Developer
- project-beta-team → Developer
- all-staff → Viewer
```

## トラブルシューティング

### 問題1: 同期が機能しない

**確認事項**:
- [ ] SAML SSOが正しく設定されているか
- [ ] ディレクトリプロバイダーの認証情報が有効か
- [ ] ネットワーク接続に問題がないか

**解決策**:
1. SAML SSO設定を確認
2. ディレクトリプロバイダーの設定を再確認
3. 手動同期をトリガー

### 問題2: ユーザーが追加されない

**確認事項**:
- [ ] ユーザーが正しいディレクトリグループに所属しているか
- [ ] グループマッピングが設定されているか
- [ ] ユーザーがSAML SSOでログインしたか

**解決策**:
1. ディレクトリプロバイダーでユーザーのグループメンバーシップを確認
2. Vercelでグループマッピングを確認
3. ユーザーにSAML SSOでログインを依頼

### 問題3: 所有者がロックアウトされた

**原因**: すべての所有者がディレクトリから削除された

**解決策**:
1. Vercelサポートに連絡
2. 緊急アクセスを要請
3. `vercel-role-owner`グループを作成して所有者を追加

### 問題4: 同期が遅い

**原因**: プロバイダーの同期頻度が低い

**解決策**:
1. 手動同期をトリガー
2. プロバイダーの同期設定を確認
3. リアルタイム同期をサポートするプロバイダーに変更を検討

## セキュリティ考慮事項

### アクセス制御

- ディレクトリ同期は強力な機能です。設定は慎重に行ってください
- 定期的にグループマッピングを確認
- 不要なグループマッピングは削除

### 監査

- アクティビティログで同期イベントを追跡
- ユーザーの追加/削除を定期的に確認
- 異常なパターンを監視

### コンプライアンス

- ディレクトリ同期の設定変更を文書化
- 監査証跡を保管
- コンプライアンス要件に従ってアクセスを管理

## ベストプラクティス

### 1. グループ構造の設計

明確で管理しやすいグループ構造を設計：

```
vercel-role-owner
vercel-role-member
project-alpha-developers
project-beta-developers
read-only-users
```

### 2. 定期的なレビュー

- 月次または四半期ごとにグループマッピングを確認
- 不要なグループマッピングを削除
- 新しいプロジェクトやチーム用のグループを追加

### 3. ドキュメント化

- グループマッピングの意図を文書化
- 変更履歴を記録
- オンボーディングプロセスに含める

### 4. テストと検証

- 本番環境で有効化する前にテスト
- 小規模なグループで検証
- 段階的にロールアウト

## 無効化

ディレクトリ同期を無効化する場合：

1. 「ディレクトリ同期」設定に移動
2. 「ディレクトリ同期を無効化」ボタンをクリック
3. 確認ダイアログで無効化を確認

**注意**:
- 無効化しても、既存のユーザーは削除されません
- 手動でユーザー管理が必要になります
- グループマッピング設定は保持されます

## 関連リソース

- [SAML SSO](/docs/saml)
- [役割とアクセス制御](/docs/rbac)
- [チーム管理](/docs/teams)
- [セキュリティベストプラクティス](/docs/security)
- [アクティビティログ](/docs/activity-log)
