# Vercel認証

## 概要

Vercel認証は、デプロイメントへのアクセスをVercelアカウントを持つユーザーに制限するセキュリティ機能です。

### 対象プラン

すべてのVercelプランで利用可能

### 主な特徴

シンプルで効果的なアクセス制御を提供し、チームメンバーのみがデプロイメントにアクセスできるようにします。

## アクセス可能なユーザー

以下のユーザーがデプロイメントにアクセスできます：

### 自動的にアクセス可能

- **チームメンバー**: Viewerロール以上
- **プロジェクトメンバー**: プロジェクトに招待されたユーザー
- **アクセスグループのメンバー**: 特定のアクセスグループに所属するユーザー

### リクエストによるアクセス

- **承認されたVercelユーザー**: アクセスリクエストが承認されたユーザー
- **共有リンクを持つユーザー**: 共有可能リンク経由でアクセスするユーザー
- **自動化ツール**: バイパスシークレットを使用するツール

## アクセスリクエスト機能

### 外部ユーザーのアクセスリクエスト

Vercelアカウントを持つ外部ユーザーは、デプロイメントへのアクセスをリクエストできます：

#### リクエストフロー

1. **ユーザーがデプロイメントにアクセス試行**
   - 保護されたデプロイメントURLにアクセス
   - アクセス拒否ページが表示される

2. **アクセスリクエストの送信**
   - 「Request Access」ボタンをクリック
   - 簡単なメッセージを追加（オプション）
   - リクエストを送信

3. **管理者への通知**
   - チーム管理者にメール通知が送信される
   - Vercelダッシュボードに通知が表示される

4. **リクエストの承認/拒否**
   - 管理者がダッシュボードでリクエストを確認
   - 承認または拒否を選択
   - リクエスト元のユーザーに通知

5. **アクセス許可**
   - 承認された場合、ユーザーはデプロイメントにアクセス可能
   - アクセス権は永続的（削除されるまで有効）

### Hobbyプランの制限

- **1つの外部ユーザーのみ承認可能**
- 追加のユーザーをリクエスト承認するには、既存の承認を削除する必要があります

### ProおよびEnterpriseプラン

- 外部ユーザー数に制限なし
- 複数のユーザーのアクセスリクエストを同時に承認可能

## 管理方法

### ダッシュボードから管理

#### Vercel認証の有効化

1. Vercelダッシュボードからプロジェクトを選択
2. 「設定」タブに移動
3. 「デプロイメント保護」を選択
4. 「Vercel認証」トグルを有効化
5. 保護する環境を選択：
   - **標準保護**: 本番カスタムドメイン以外のすべてのドメイン
   - **すべてのデプロイメント**: カスタムドメインを含むすべて
   - **プレビューのみ**: プレビューデプロイメントのみ
6. 「保存」をクリック

#### アクセスリクエストの管理

1. プロジェクト設定に移動
2. 「デプロイメント保護」を選択
3. 「アクセスリクエスト」セクションを確認
4. 各リクエストに対して「承認」または「拒否」を選択

#### 承認されたユーザーの管理

1. プロジェクト設定に移動
2. 「デプロイメント保護」 > 「アクセス」タブ
3. 「承認されたユーザー」リストを確認
4. 不要なユーザーのアクセスを削除

### API経由で管理

#### Vercel認証の設定

```bash
curl -X PATCH "https://api.vercel.com/v9/projects/PROJECT_ID" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ssoProtection": {
      "deploymentType": "prod_deployment_urls_and_all_previews"
    }
  }'
```

#### 環境タイプのオプション

- `preview`: プレビューデプロイメントのみ
- `prod_deployment_urls_and_all_previews`: すべてのデプロイメント（標準保護）
- `all`: すべてのデプロイメント（カスタムドメイン含む）

#### Vercel認証の無効化

```bash
curl -X PATCH "https://api.vercel.com/v9/projects/PROJECT_ID" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ssoProtection": null
  }'
```

## セキュリティ考慮事項

### 環境ごとの保護

| 環境タイプ | 推奨設定 | 理由 |
|-----------|---------|------|
| プレビューデプロイメント | 有効 | 内部レビューのみ許可 |
| 本番Vercel URL | 有効 | 直接アクセスを制限 |
| カスタムドメイン | 無効 | 公開サイトとして機能 |

### 他の保護方法との互換性

Vercel認証は、以下の保護方法と組み合わせて使用できます：

- **パスワード保護**: Vercelアカウント + パスワード
- **信頼できるIP**: 特定IP + Vercelアカウント
- **両方**: 最高レベルのセキュリティ

### バイパス方法

以下の方法でVercel認証をバイパスできます：

- **共有可能リンク**: 一時的な外部アクセス
- **自動化バイパス**: E2Eテスト用
- **デプロイメント保護の例外**: 特定ドメインを公開

## ユースケース

### 1. 内部レビュー

**シナリオ**: チームメンバーのみがプレビューデプロイメントにアクセス

```json
{
  "ssoProtection": {
    "deploymentType": "preview"
  }
}
```

**効果**:
- プレビューデプロイメントはチームメンバーのみアクセス可能
- 本番サイトは公開

### 2. 完全な保護

**シナリオ**: すべてのデプロイメントをチームメンバーのみに制限

```json
{
  "ssoProtection": {
    "deploymentType": "all"
  }
}
```

**効果**:
- すべてのURL（カスタムドメイン含む）が保護される
- Vercelアカウントでログインが必要

### 3. 外部コラボレーター

**シナリオ**: 特定の外部ユーザーにアクセスを許可

```
1. 外部ユーザーがアクセスリクエストを送信
2. 管理者がリクエストを承認
3. 外部ユーザーがアクセス可能に
```

## ユーザーエクスペリエンス

### ログインフロー

1. **ユーザーが保護されたデプロイメントにアクセス**
2. **Vercelログインページにリダイレクト**
3. **ログイン方法を選択**:
   - メール（OTP）
   - GitHub
   - GitLab
   - Bitbucket
   - パスキー
   - SAML SSO（エンタープライズ）
4. **認証完了**
5. **元のデプロイメントURLにリダイレクト**

### Cookieの持続性

- ログイン状態はCookieに保存される
- ブラウザセッションが終了するまで有効
- 複数のデプロイメントで共有される

## 複数の保護方法との組み合わせ

### Vercel認証 + パスワード保護

```json
{
  "ssoProtection": {
    "deploymentType": "all"
  },
  "passwordProtection": {
    "deploymentType": "all",
    "password": "strong-password"
  }
}
```

**効果**: Vercelアカウントでログインし、かつパスワードを入力したユーザーのみアクセス可能

### Vercel認証 + 信頼できるIP

```json
{
  "ssoProtection": {
    "deploymentType": "all"
  },
  "trustedIps": {
    "deploymentType": "all",
    "addresses": [
      {
        "value": "203.0.113.0/24",
        "note": "Office network"
      }
    ]
  }
}
```

**効果**: オフィスネットワークからアクセスし、かつVercelアカウントでログインしているユーザーのみアクセス可能

## トラブルシューティング

### 問題1: チームメンバーがアクセスできない

**確認事項**:
- [ ] チームメンバーがVercelアカウントにログインしているか
- [ ] チームメンバーの役割が適切か（Viewer以上）
- [ ] プロジェクトにメンバーが追加されているか

**解決策**:
1. チームメンバーをプロジェクトに追加
2. 適切な役割を割り当て
3. Vercelアカウントでログインを確認

### 問題2: 外部ユーザーのアクセスリクエストが届かない

**確認事項**:
- [ ] メール通知が有効か
- [ ] スパムフォルダを確認
- [ ] 正しいメールアドレスが登録されているか

**解決策**:
1. アカウント設定でメール通知を確認
2. ダッシュボードで直接リクエストを確認

### 問題3: ログインループ

**原因**: Cookieが正しく設定されていない

**解決策**:
1. ブラウザのキャッシュとCookieをクリア
2. シークレットモードで試す
3. 別のブラウザで試す

### 問題4: Hobbyプランで2人目のユーザーを承認できない

**原因**: Hobbyプランは1ユーザーのみ承認可能

**解決策**:
1. 既存の承認を削除
2. 新しいユーザーを承認
3. または、Proプランにアップグレード

## ベストプラクティス

### 1. 環境別の保護

プレビューと本番で異なる保護レベルを設定：

```
プレビュー: Vercel認証有効
本番: カスタムドメインは公開、Vercel URLは保護
```

### 2. アクセスの定期的なレビュー

- 月次または四半期ごとに承認されたユーザーを確認
- 退職者やプロジェクト離脱者のアクセスを削除
- 不要な外部アクセスを削除

### 3. 外部アクセスの管理

外部ユーザーへのアクセス許可は慎重に：

- アクセスの理由を明確に
- 期限を設定（手動で削除）
- プロジェクト終了後、アクセスを削除

### 4. 多層防御

可能であれば、複数の保護方法を組み合わせる：

```json
{
  "ssoProtection": { ... },
  "trustedIps": { ... }
}
```

## セキュリティのヒント

### アカウントセキュリティ

- チームメンバーに2要素認証を強制
- 強力なパスワードポリシーを実施
- パスキーの使用を推奨

### 監査とモニタリング

- アクティビティログでVercel認証設定の変更を追跡
- アクセスリクエストの承認/拒否を記録
- 異常なアクセスパターンを監視

### コンプライアンス

- アクセス制御ポリシーを文書化
- 定期的なアクセスレビューを実施
- 監査証跡を保管

## 無効化の影響

Vercel認証を無効化すると：

- すべての既存のデプロイメントが保護解除される
- 承認されたユーザーのアクセス権は維持されるが、無効
- 再度有効化すると、以前の設定が復元される

**注意**: 無効化する前に、影響を慎重に検討してください。

## 関連リソース

- [デプロイメント保護](/docs/deployment-protection)
- [デプロイメント保護の方法](/docs/deployment-protection/methods-to-protect-deployments)
- [パスワード保護](/docs/deployment-protection/methods-to-protect-deployments/password-protection)
- [信頼できるIP](/docs/deployment-protection/methods-to-protect-deployments/trusted-ips)
- [役割とアクセス制御](/docs/rbac)
- [2要素認証](/docs/two-factor-authentication)
