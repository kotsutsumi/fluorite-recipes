# Vercelデプロイメント保護の方法

## 概要

Vercelは、デプロイメントを保護するための3つの主要な方法を提供しています。これらの方法を組み合わせることで、セキュリティを強化し、適切なアクセス制御を実現できます。

## 保護方法の比較

| 保護方法 | 対象プラン | 主な用途 | セキュリティレベル |
|---------|----------|---------|------------------|
| Vercel認証 | すべて | チームメンバーのみアクセス | 中 |
| パスワード保護 | Enterprise/アドオン | パスワード共有によるアクセス制御 | 中〜高 |
| 信頼できるIP | Enterprise | 特定ネットワークからのみアクセス | 高 |

## 1. Vercel認証

### 概要

- **対象プラン**: すべてのプランで利用可能
- **機能**: Vercelアカウントを持つチームメンバーのみがデプロイメントにアクセス可能
- **用途**: 内部レビュー、チーム内共有

### 主な特徴

#### アクセス可能なユーザー

- チームメンバー（Viewerロール以上）
- プロジェクトメンバー
- アクセスグループのメンバー
- 承認されたVercelユーザー

#### アクセスリクエスト機能

外部ユーザーがデプロイメントへのアクセスをリクエストできます：

1. 外部ユーザーが保護されたデプロイメントにアクセス
2. アクセスリクエストフォームが表示
3. リクエストを送信
4. チーム管理者がリクエストを承認/拒否
5. 承認された場合、ユーザーはアクセス可能に

**Hobbyプランの制限**: 1つの外部ユーザーのみ許可

### 設定方法

#### ダッシュボードから設定

1. プロジェクトを選択
2. 「設定」タブ > 「デプロイメント保護」
3. 「Vercel認証」を有効化
4. 保護する環境を選択：
   - 標準保護（プレビューのみ）
   - すべてのデプロイメント
   - 本番デプロイメントのみ
5. 設定を保存

#### APIから設定

```bash
curl -X PATCH "https://api.vercel.com/v9/projects/PROJECT_ID" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "ssoProtection": {
      "deploymentType": "prod_deployment_urls_and_all_previews"
    }
  }'
```

### 詳細

[Vercel認証](/docs/deployment-protection/methods-to-protect-deployments/vercel-authentication)を参照してください。

## 2. パスワード保護

### 概要

- **対象プラン**: エンタープライズプランまたはPro プランのアドオン
- **機能**: 正しいパスワードを持つユーザーのみアクセス可能
- **用途**: 外部ステークホルダーとの共有、クライアントレビュー

### 主な特徴

#### 柔軟なアクセス制御

- 公開・非公開の両方のデプロイメントにアクセス制限を設定可能
- 環境に応じて異なる保護レベルを設定可能
- パスワードは環境ごとに設定可能

#### パスワードの管理

- 強力なパスワードの設定を推奨
- パスワードの定期的な変更が可能
- パスワード変更時、ユーザーは再入力が必要

### 設定方法

#### ダッシュボードから設定

1. プロジェクト設定に移動
2. 「デプロイメント保護」セクションを選択
3. 「パスワード保護」を有効化
4. 環境を選択：
   - プレビューのみ
   - すべてのデプロイメント
   - 本番デプロイメントのみ
5. 強力なパスワードを設定
6. 設定を保存

#### APIから設定

```bash
curl -X PATCH "https://api.vercel.com/v9/projects/PROJECT_ID" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "passwordProtection": {
      "deploymentType": "all",
      "password": "strong-password-here"
    }
  }'
```

### セキュリティのベストプラクティス

1. **強力なパスワード**: 12文字以上、大文字・小文字・数字・記号を含む
2. **定期的な変更**: 90日ごとにパスワードを変更
3. **安全な共有**: パスワードは暗号化されたチャネルで共有
4. **最小限の共有**: 必要な人にのみパスワードを共有

### 詳細

[パスワード保護](/docs/deployment-protection/methods-to-protect-deployments/password-protection)を参照してください。

## 3. 信頼できるIP

### 概要

- **対象プラン**: エンタープライズプランのみ
- **機能**: 特定のIPアドレスからのみアクセスを許可
- **用途**: 企業VPN、オフィスネットワークからのみアクセスを許可

### 主な特徴

#### IPアドレスの管理

- IPv4アドレスをサポート
- IPv4 CIDRレンジをサポート
- 複数のIPアドレス/レンジを追加可能
- 各IPアドレスにメモを追加可能

#### 柔軟な設定

- プロジェクトの異なる環境（プレビュー、本番）で設定可能
- Vercel認証やパスワード保護と組み合わせて使用可能

### 設定方法

#### ダッシュボードから設定

1. プロジェクト設定に移動
2. 「デプロイメント保護」を選択
3. 「信頼できるIP」を有効化
4. IPアドレスを追加：
   - 単一IPアドレス（例：`203.0.113.10`）
   - CIDRレンジ（例：`203.0.113.0/24`）
5. 各IPにメモを追加（オプション）
6. 保護する環境を選択
7. 設定を保存

#### APIから設定

```bash
curl -X PATCH "https://api.vercel.com/v9/projects/PROJECT_ID" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "trustedIps": {
      "deploymentType": "prod_deployment_urls_and_all_previews",
      "addresses": [
        {
          "value": "203.0.113.0/24",
          "note": "Office network"
        },
        {
          "value": "198.51.100.10",
          "note": "VPN gateway"
        }
      ]
    }
  }'
```

### IPアドレスの確認方法

現在のIPアドレスを確認：

```bash
curl https://api.ipify.org
```

### ユースケース

1. **オフィスネットワーク**: オフィスからのみアクセスを許可
2. **VPN**: 企業VPN経由のみアクセスを許可
3. **特定のデータセンター**: 特定のクラウドプロバイダーからのみアクセスを許可
4. **外部プロキシ**: リバースプロキシ経由のみアクセスを許可

### 詳細

[信頼できるIP](/docs/deployment-protection/methods-to-protect-deployments/trusted-ips)を参照してください。

## 保護方法の組み合わせ

### 複数の保護方法を組み合わせる

エンタープライズプランでは、複数の保護方法を同時に使用できます：

#### 例1: Vercel認証 + 信頼できるIP

```json
{
  "ssoProtection": {
    "deploymentType": "all"
  },
  "trustedIps": {
    "deploymentType": "all",
    "addresses": [
      {
        "value": "203.0.113.0/24",
        "note": "Office network"
      }
    ]
  }
}
```

**効果**: オフィスネットワークからアクセスし、かつVercelアカウントでログインしているユーザーのみアクセス可能

#### 例2: パスワード保護 + 信頼できるIP

```json
{
  "passwordProtection": {
    "deploymentType": "preview",
    "password": "strong-password"
  },
  "trustedIps": {
    "deploymentType": "prod_deployment_urls_and_all_previews",
    "addresses": [
      {
        "value": "203.0.113.0/24",
        "note": "Office network"
      }
    ]
  }
}
```

**効果**:
- プレビュー: オフィスネットワークからアクセスし、パスワードを入力したユーザーのみアクセス可能
- 本番: オフィスネットワークからのみアクセス可能

## 保護方法の選択ガイド

### 内部レビュー

**推奨**: Vercel認証

- チームメンバーのみアクセス
- シンプルな設定
- すべてのプランで利用可能

### 外部ステークホルダー

**推奨**: パスワード保護 または 共有可能リンク

- Vercelアカウント不要
- 柔軟なアクセス制御
- パスワード共有で簡単にアクセス

### 企業セキュリティ要件

**推奨**: 信頼できるIP + Vercel認証

- 最高レベルのセキュリティ
- ネットワークレベルの制御
- エンタープライズプランが必要

### 公開デモ環境

**推奨**: デプロイメント保護の例外

- 特定のドメインを公開
- 選択的なアクセス制御
- エンタープライズプランまたはアドオンが必要

## セキュリティ考慮事項

### 環境別の保護

異なる環境で異なる保護レベルを設定することを推奨：

- **プレビュー**: Vercel認証 + パスワード保護
- **本番**: 信頼できるIP（必要に応じて）

### 監査とモニタリング

1. アクティビティログで保護設定の変更を追跡
2. 定期的に保護設定を確認
3. 不要なバイパス方法を削除

### ベストプラクティス

1. **最小権限の原則**: 必要最小限のアクセスのみ許可
2. **定期的なレビュー**: 保護設定を定期的に見直し
3. **多層防御**: 複数の保護方法を組み合わせる
4. **監査証跡**: すべての変更をログに記録

## トラブルシューティング

### よくある問題

#### 問題1: 本番サイトにアクセスできない

**確認事項**:
- 保護設定が意図した環境に適用されているか
- カスタムドメインが保護対象か

**解決策**:
1. 保護設定を確認
2. 必要に応じて設定を調整

#### 問題2: チームメンバーがアクセスできない

**確認事項**:
- チームメンバーの役割が適切か
- Vercel認証が有効か

**解決策**:
1. チームメンバーの役割を確認
2. 必要に応じてアクセス権を付与

#### 問題3: IPベースの保護が機能しない

**確認事項**:
- IPアドレスが正しく設定されているか
- 動的IPアドレスを使用していないか

**解決策**:
1. 現在のIPアドレスを確認
2. CIDRレンジで広めに設定
3. または、VPN使用を検討

## 関連リソース

- [デプロイメント保護](/docs/deployment-protection)
- [デプロイメント保護のバイパス方法](/docs/deployment-protection/methods-to-bypass-deployment-protection)
- [セキュリティベストプラクティス](/docs/security)
- [役割とアクセス制御](/docs/rbac)
