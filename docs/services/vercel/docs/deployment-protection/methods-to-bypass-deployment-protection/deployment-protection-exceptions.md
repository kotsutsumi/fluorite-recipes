# デプロイメント保護の例外

## 概要

デプロイメント保護の例外は、特定のプレビューデプロイメントドメインを保護から除外し、公開アクセス可能にする機能です。

### 対象プラン

- [エンタープライズプラン](/docs/plans/enterprise)
- [Pro プランのAdvanced Deployment Protection](/docs/security/deployment-protection#advanced-deployment-protection)アドオン

### 必要な権限

以下のいずれかの役割が必要：
- オーナー
- メンバー
- 管理者

## 主な機能

### 無効化される保護

デプロイメント保護例外に追加されたドメインでは、以下の保護機能が無効化されます：

- **Vercel認証**: Vercelアカウントでのログイン要件
- **パスワード保護**: パスワード入力要件
- **信頼できるIP**: IP制限

### 適用範囲

- **対象**: プレビューデプロイメントドメインのみ
- **対象外**: 本番デプロイメントドメインは対象外

## デプロイメント保護例外の追加手順

### ダッシュボードから追加

1. Vercelダッシュボードからプロジェクトを選択
2. 「設定」タブに移動
3. 「デプロイメント保護」セクションを選択
4. 「例外」タブをクリック
5. 「ドメインを追加」ボタンをクリック
6. 保護を解除するドメインを入力
   - 例：`feature-branch-*.vercel.app`
   - 例：`demo-*.vercel.app`
7. 「追加」をクリック
8. 確認プロセスを完了

### APIから追加

```bash
curl -X POST "https://api.vercel.com/v1/projects/PROJECT_ID/deployment-protection/exceptions" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "domain": "feature-branch-*.vercel.app"
  }'
```

## ドメインパターンの指定

### 完全一致

特定のドメインを指定：

```
my-feature-abc123.vercel.app
```

### ワイルドカード

パターンマッチングを使用：

```
feature-*.vercel.app
demo-*.vercel.app
staging-*.vercel.app
```

**注意**: ワイルドカード（`*`）は、ドメインの一部を柔軟に指定できます。

## 例外の管理

### 例外の確認

デプロイメント保護設定ページで、現在の例外リストを確認できます：

1. プロジェクト設定に移動
2. 「デプロイメント保護」を選択
3. 「アクセス」タブをクリック
4. 「すべてのアクセス」セクションを展開
5. 「保護されていないプレビュー」で例外を確認

### 例外の削除

例外を削除すると、プロジェクトの元のデプロイメント保護設定が再適用されます：

1. 例外リストで削除したいドメインを見つける
2. 「削除」アイコンをクリック
3. 確認ダイアログで削除を確認

### APIから削除

```bash
curl -X DELETE "https://api.vercel.com/v1/projects/PROJECT_ID/deployment-protection/exceptions/EXCEPTION_ID" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## ユースケース

### 1. 公開デモ環境

特定のブランチを常に公開アクセス可能にする：

```
demo-*.vercel.app
```

**シナリオ**:
- クライアントへのデモプレゼンテーション
- 営業チームが顧客に見せる環境
- マーケティング用のプレビュー

### 2. パートナー向けプレビュー

特定のパートナー向けのプレビュー環境：

```
partner-preview-*.vercel.app
```

**シナリオ**:
- 統合パートナーとの開発
- サードパーティとの連携テスト
- 外部レビュアー向けの環境

### 3. 特定のブランチ

開発ブランチを公開する：

```
feature-public-*.vercel.app
```

**シナリオ**:
- オープンソースプロジェクト
- コミュニティフィードバック収集
- 公開ベータテスト

## セキュリティ考慮事項

### 重要な注意点

#### 公開アクセス

- **警告**: ドメインを例外に追加すると、そのドメインは**完全に公開**されます
- 誰でもURLにアクセスできるようになります
- 機密情報を含むデプロイメントは例外に追加しないでください

#### データ保護

- 公開する前にデプロイメント内容を確認
- 環境変数に機密情報が含まれていないか確認
- データベース接続情報などが露出していないか確認

#### ベストプラクティス

1. **最小限の例外**: 必要最小限のドメインのみを例外に追加
2. **定期的なレビュー**: 例外リストを定期的に見直し、不要なものは削除
3. **命名規則**: 例外ドメインには明確な命名規則を使用
4. **監査ログ**: アクティビティログで例外の追加・削除を追跡

## トラブルシューティング

### 問題1: 例外が適用されない

**原因**:
- ドメインパターンが正しくない
- 設定が保存されていない
- 例外が適用されるまでに時間がかかる場合がある

**解決策**:
1. ドメインパターンを確認
2. ブラウザのキャッシュをクリア
3. 新しいデプロイメントで確認

### 問題2: 予期しないドメインが公開される

**原因**:
- ワイルドカードパターンが広すぎる
- 例：`*.vercel.app`（すべてのドメインが対象）

**解決策**:
1. より具体的なパターンを使用
2. 不要な例外を削除

### 問題3: 本番環境も公開されてしまう

**原因**:
- 誤解：例外はプレビューデプロイメントのみ対象

**確認**:
- 本番ドメインは例外の対象外
- 本番保護は別途設定が必要

## 実装例

### 例1: 複数のデモ環境

```json
{
  "exceptions": [
    "demo-alpha-*.vercel.app",
    "demo-beta-*.vercel.app",
    "demo-stable-*.vercel.app"
  ]
}
```

### 例2: ブランチベースの例外

```json
{
  "exceptions": [
    "public-*-*.vercel.app",
    "showcase-*-*.vercel.app"
  ]
}
```

### 例3: プロジェクト固有のパターン

```json
{
  "exceptions": [
    "myproject-public-preview-*.vercel.app"
  ]
}
```

## 制限事項

### ドメインの制限

- プレビューデプロイメントドメインのみ対象
- 本番カスタムドメインは対象外
- Vercelが発行するドメイン（`.vercel.app`）に限定

### プランの制限

- エンタープライズプランまたは有料アドオンが必要
- Hobbyプランでは使用不可

### パターンマッチング

- ワイルドカード（`*`）のみサポート
- 正規表現は使用不可
- 大文字小文字は区別されない

## 関連リソース

- [デプロイメント保護](/docs/deployment-protection)
- [デプロイメント保護のバイパス方法](/docs/deployment-protection/methods-to-bypass-deployment-protection)
- [Advanced Deployment Protection](/docs/security/deployment-protection#advanced-deployment-protection)
- [セキュリティベストプラクティス](/docs/security)
