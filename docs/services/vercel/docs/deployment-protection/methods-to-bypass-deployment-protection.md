# Vercel デプロイメント保護のバイパス方法

## 概要

Vercelでは、デプロイメント保護を柔軟にバイパスする4つの主要な方法を提供しています。これらの方法により、セキュリティを維持しながら、特定のユースケースに対応できます。

## バイパス方法の比較

| 方法 | 対象プラン | 用途 | 難易度 |
|------|----------|------|--------|
| 共有可能リンク | すべて | 外部レビュー | 簡単 |
| 自動化バイパス | すべて | E2Eテスト | 中 |
| 保護例外 | Enterprise/アドオン | 特定ドメインの公開 | 中 |
| OPTIONSホワイトリスト | すべて | CORS | 簡単 |

## 1. 共有可能リンク

### 概要

- **対象プラン**: すべてのプランで利用可能
- **用途**: 外部レビュアーやステークホルダーとのデプロイメント共有
- **方法**: クエリパラメータを追加してアクセスを許可

### 特徴

- セキュアな方法でプレビューデプロイメントを共有
- コメント機能も利用可能
- 特定のデプロイメントに限定したアクセス

### 使用方法

1. デプロイメントページで「共有」ボタンをクリック
2. 「Anyone with the link」を選択
3. 生成されたリンクを共有

### 詳細

[共有可能リンク](/docs/deployment-protection/methods-to-bypass-deployment-protection/sharable-links)を参照してください。

## 2. 自動化のための保護バイパス

### 概要

- **対象プラン**: すべてのプランで利用可能
- **用途**: E2Eテスト、自動化ツール、CI/CDパイプライン
- **方法**: プロジェクト全体のデプロイメントを保護解除するシークレットを生成

### 特徴

- すべてのデプロイメントで使用可能な永続的なシークレット
- ヘッダーまたはクエリパラメータで送信
- セキュアな自動化テストが可能

### 使用方法

1. プロジェクト設定でバイパスシークレットを生成
2. テストツールにシークレットを設定
3. リクエストヘッダーに`x-vercel-protection-bypass`を追加

### サンプルコード

```typescript
// Playwright での例
const config: PlaywrightTestConfig = {
  use: {
    extraHTTPHeaders: {
      'x-vercel-protection-bypass': process.env.VERCEL_AUTOMATION_BYPASS_SECRET,
    }
  }
}
```

### 詳細

[自動化のための保護バイパス](/docs/deployment-protection/methods-to-bypass-deployment-protection/protection-bypass-automation)を参照してください。

## 3. デプロイメント保護の例外

### 概要

- **対象プラン**: エンタープライズプランまたは高度なデプロイメント保護アドオン
- **用途**: 特定のプレビュードメインを公開アクセス可能にする
- **方法**: 認証、パスワード保護、信頼できるIPなどの設定を無視

### 特徴

- ドメインベースの例外設定
- 細かいアクセス制御が可能
- 本番環境には影響しない

### 使用方法

1. デプロイメント保護設定に移動
2. 「例外」セクションでドメインを追加
3. 保護を解除するドメインを指定

### ユースケース

- 特定のブランチのプレビューを公開する
- 公開デモ環境を作成する
- パートナー向けの専用プレビュー環境

### 詳細

[デプロイメント保護の例外](/docs/deployment-protection/methods-to-bypass-deployment-protection/deployment-protection-exceptions)を参照してください。

## 4. OPTIONSホワイトリスト

### 概要

- **対象プラン**: すべてのプランで利用可能
- **用途**: CORSプリフライトリクエスト
- **方法**: 特定のパスの`OPTIONS`リクエストを保護から除外

### 特徴

- パスベースの設定
- CORSプリフライトリクエストのみ対象
- APIエンドポイントに最適

### 使用方法

1. デプロイメント保護設定に移動
2. OPTIONSホワイトリストトグルを有効化
3. 保護を解除するパスを追加（例：`/api`）

### サンプル設定

```json
{
  "optionsAllowlist": {
    "paths": [
      "/api",
      "/webhooks"
    ]
  }
}
```

### 詳細

[OPTIONSホワイトリスト](/docs/deployment-protection/methods-to-bypass-deployment-protection/options-allowlist)を参照してください。

## バイパス方法の選択ガイド

### 外部レビューが必要な場合

**推奨**: 共有可能リンク

- クライアントやステークホルダーとのレビュー
- 一時的なアクセスが必要な場合
- コメント機能を活用したい場合

### 自動化テストを実行する場合

**推奨**: 自動化のための保護バイパス

- E2Eテスト（Playwright、Cypressなど）
- CI/CDパイプライン
- 継続的な統合テスト

### 特定の環境を公開したい場合

**推奨**: デプロイメント保護の例外

- 公開デモ環境
- 特定のブランチのプレビュー
- パートナー向けの専用環境

### CORSエラーを解決したい場合

**推奨**: OPTIONSホワイトリスト

- APIエンドポイントのプリフライトリクエスト
- クロスオリジンリクエストの許可
- Webhookエンドポイント

## セキュリティ考慮事項

### 共有可能リンク

- リンクを持つ誰でもアクセス可能
- リンクの有効期限を設定できない
- 必要に応じてリンクを無効化

### 自動化バイパス

- シークレットを安全に保管
- 環境変数として管理
- 定期的にシークレットをローテーション

### 保護例外

- 公開アクセスになることを理解
- 必要最小限のドメインのみ例外に追加
- 定期的に例外を見直し

### OPTIONSホワイトリスト

- `OPTIONS`リクエストのみが対象
- 他のHTTPメソッドは保護される
- パスの設定に注意

## ベストプラクティス

### 1. 最小権限の原則

必要最小限のバイパス方法のみを使用し、不要になったら削除します。

### 2. 監査とレビュー

バイパス設定を定期的にレビューし、不要なものは削除します。

### 3. ドキュメント化

どのバイパス方法を使用しているか、その理由を文書化します。

### 4. セキュアな管理

シークレットやパスワードは、環境変数や秘密管理ツールで管理します。

## トラブルシューティング

### 共有可能リンクが機能しない

**確認事項:**
- リンクが正しくコピーされているか
- デプロイメントがまだ存在するか
- リンクが無効化されていないか

### 自動化バイパスが機能しない

**確認事項:**
- シークレットが正しく設定されているか
- ヘッダー名が正確か（`x-vercel-protection-bypass`）
- シークレットが再生成されていないか

### 保護例外が適用されない

**確認事項:**
- ドメインが正確に入力されているか
- プランがエンタープライズまたはアドオンを購入しているか
- 設定が保存されているか

### OPTIONSホワイトリストが機能しない

**確認事項:**
- パスが正しく設定されているか
- リクエストメソッドが`OPTIONS`か
- トグルが有効化されているか

## 関連リソース

- [デプロイメント保護](/docs/deployment-protection)
- [デプロイメント保護の方法](/docs/deployment-protection/methods-to-protect-deployments)
- [セキュリティベストプラクティス](/docs/security)
