# Firewall Observability

Vercelファイアウォールは、包括的な観測性機能を提供し、トラフィックパターンの理解とセキュリティ脅威の検出を支援します。

## トラフィック監視

Vercelプロジェクトの「Firewall」タブでは、本番デプロイメントの総受信ウェブトラフィックを特定の期間にわたって折れ線グラフで表示できます。

### トラフィック表示設定

デフォルトでは過去1時間の概要が表示され、以下の設定を変更できます：

#### トラフィックのグループ化オプション

- **概要**（デフォルト）: トラフィック制御ルールのカテゴリまたはアクション（許可、チャレンジ、拒否、ログ）でグループ化
- **その他のオプション**:
  - リージョン
  - IPアドレス
  - ユーザーエージェント
  - リクエストパス
  - ルート
  - JA4ダイジェスト
  - 国

#### 時間期間

- **ライブ**: 10分ウィンドウ（リアルタイム更新）
- **過去1時間**: 直近60分間
- **過去24時間**: 直近1日間
- **過去3日間**: 直近72時間（Enterpriseプラン）

### トラフィックグラフの読み方

グラフには以下の情報が表示されます：

- **Y軸**: リクエスト数
- **X軸**: 時間
- **色分け**: アクションまたは選択したグループ化オプション
- **ホバー**: 特定の時点の詳細情報

### トラフィックフィルタリング

特定のトラフィックタイプにフォーカスするためのフィルター：

- **アクション別**: 許可、チャレンジ、拒否、ログ
- **ソース別**: 特定のIPアドレス、国、ASN
- **ルール別**: 特定のカスタムルールまたはマネージドルールセット
- **パス別**: 特定のURLパスまたはルート

## ファイアウォールログ

詳細なリクエストログを確認できます：

### ログエントリの情報

各ログエントリには以下が含まれます：

- **タイムスタンプ**: リクエストの日時
- **IPアドレス**: クライアントのIPアドレス
- **国/リージョン**: IPアドレスから判定した地理的位置
- **パス**: リクエストされたURLパス
- **メソッド**: HTTPメソッド（GET、POST等）
- **ユーザーエージェント**: クライアントのユーザーエージェント文字列
- **アクション**: 適用されたアクション（許可、拒否、チャレンジ）
- **ルール**: トリガーされたルール名
- **JA3/JA4指紋**: TLSクライアント指紋（該当する場合）

### ログの検索とフィルタリング

ログは以下の条件で検索・フィルタリングできます：

```
IP address: 192.0.2.1
Path: /api/*
Action: denied
Rule: "Block suspicious IPs"
Country: CN
```

### ログのエクスポート

ログデータをエクスポートして外部分析ツールで使用できます：

1. ファイアウォールタブで「Logs」を選択
2. 期間とフィルターを設定
3. 「Export」ボタンをクリック
4. CSV または JSON 形式でダウンロード

## ファイアウォールアラート

セキュリティ上の潜在的な脅威に対して通知を設定できます。

### アラートの種類

#### DDoS攻撃アラート

100,000リクエスト/10分を超える悪意のあるトラフィックを検出した場合、アラートが生成されます。

#### レート制限超過アラート

特定のレート制限ルールが頻繁にトリガーされた場合に通知します。

#### 異常なトラフィックパターン

通常と大きく異なるトラフィックパターンを検出した場合に警告します。

### アラートの設定方法

#### Webhookを使用

1. プロジェクト設定 > Integrations > Webhooks
2. 「Add Webhook」を選択
3. イベントタイプで「Firewall Alert」を選択
4. エンドポイントURLを入力
5. 保存

Webhookペイロードの例：

```json
{
  "type": "firewall.ddos_alert",
  "timestamp": "2025-10-20T12:00:00Z",
  "projectId": "prj_xxx",
  "alert": {
    "severity": "high",
    "message": "DDoS attack detected: 150,000 requests in 10 minutes",
    "affectedIPs": ["192.0.2.1", "198.51.100.50"],
    "duration": "600s"
  }
}
```

#### Vercel Slackアプリを使用

1. Slackワークスペースに Vercel アプリをインストール
2. プロジェクト設定 > Integrations > Slack
3. 通知チャンネルを選択
4. ファイアウォールアラートを有効化

### アラート通知の内容

アラートには以下の情報が含まれます：

- 検出された脅威のタイプ
- 影響を受けたIPアドレスまたはリージョン
- トラフィック量と期間
- 推奨される対応アクション
- ダッシュボードへのリンク

## メトリクスとダッシュボード

### 主要メトリクス

ファイアウォールダッシュボードには以下のメトリクスが表示されます：

#### リクエストメトリクス

- **総リクエスト数**: 選択した期間の総リクエスト数
- **許可されたリクエスト**: 通過したリクエスト数
- **ブロックされたリクエスト**: 拒否されたリクエスト数
- **チャレンジされたリクエスト**: チャレンジが提示されたリクエスト数

#### トップソース

- **トップIPアドレス**: 最もリクエストが多いIPアドレス
- **トップ国**: 最もトラフィックが多い国
- **トップユーザーエージェント**: 最も使用されているユーザーエージェント

#### ルールパフォーマンス

- **最もトリガーされたルール**: 頻繁にマッチするルール
- **ルール別ブロック率**: 各ルールのブロック効果
- **誤検知の可能性**: 正当なトラフィックをブロックしている可能性のあるルール

## 統合とエクスポート

### 外部監視ツールとの統合

ファイアウォールデータを以下のツールに統合できます：

#### Datadog

```typescript
// Datadog統合の例
import { datadogLogs } from '@datadog/browser-logs';

// ファイアウォールイベントをDatadogに送信
datadogLogs.logger.info('Firewall event', {
  action: 'denied',
  ip: '192.0.2.1',
  rule: 'Block malicious IPs',
  path: '/api/endpoint',
});
```

#### Splunk

```bash
# Splunk HTTPイベントコレクターへの送信
curl -X POST "https://splunk.example.com:8088/services/collector" \
  -H "Authorization: Splunk <token>" \
  -d '{
    "event": {
      "action": "denied",
      "ip": "192.0.2.1",
      "rule": "Block malicious IPs"
    }
  }'
```

#### Custom SIEM

カスタムSIEMソリューションへのログストリーミングも可能です。詳細は[Audit Logs](/docs/audit-log)を参照してください。

## ベストプラクティス

### 定期的な監視

1. **日次レビュー**: 毎日トラフィックパターンを確認
2. **週次分析**: 週ごとにブロック率と誤検知を分析
3. **月次レポート**: 月次でセキュリティトレンドをレビュー

### アラート設定

1. **重要度に応じた設定**: 重大な脅威には即座に通知
2. **通知の最適化**: ノイズを減らし、重要なアラートにフォーカス
3. **エスカレーションプラン**: 重大なインシデントへの対応手順を確立

### データの活用

1. **トレンド分析**: 時間経過に伴うパターンを識別
2. **脅威インテリジェンス**: 新しい攻撃パターンを検出
3. **ルールの最適化**: データに基づいてルールをチューニング

## トラブルシューティング

### よくある問題

#### ログが表示されない

1. プロジェクトとデプロイメントが正しいか確認
2. 期間設定を確認
3. フィルターをクリア

#### メトリクスの遅延

- リアルタイムデータは数分の遅延がある場合があります
- 過去のデータは通常即座に利用可能

#### エクスポートの失敗

1. 選択した期間が大きすぎないか確認
2. ブラウザのポップアップブロックを無効化
3. 再試行

詳細なトラブルシューティングについては、[Vercelサポート](https://vercel.com/support)にお問い合わせください。
