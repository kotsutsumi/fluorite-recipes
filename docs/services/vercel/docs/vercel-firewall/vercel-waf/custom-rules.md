# WAFカスタムルール

## はじめに

Vercelのウェブアプリケーションファイアウォール（WAF）カスタムルールを使用すると、特定のルールを設定して、サイトへのトラフィックをログ、拒否、チャレンジ、バイパス、または[レートリミット](/docs/security/vercel-waf/rate-limiting)することができます。

## アクセスロール

以下のロールがこの機能にアクセスできます：
- 開発者
- ビューワー（ProまたはEnterprise）
- プロジェクト管理者
- チームメンバー

## カスタムルールの設定

カスタムルールでは、以下のアクションを設定できます：
- **ログ**: リクエストを記録し、通過させる
- **拒否**: リクエストをブロックし、403を返す
- **チャレンジ**: ブラウザチャレンジを要求
- **バイパス**: 他のルールをスキップ
- **リダイレクト**: 別のURLにリダイレクト

### ルール実行

- ルールが拒否またはチャレンジを実行すると、リクエストの処理が停止します
- ログルールの実行後は、他のルールの処理が続行されます

## 永続的アクション

Enterprise and Pro プランで利用可能な機能：
- クライアントのIPアドレスに対して時間ベースのブロックを追加可能
- ルールに一致したクライアントを指定した期間ブロック

### 永続的アクションの有効化

1. プロジェクトのFirewallタブを選択
2. 「Configure」を選択
3. 新しいルールを作成または既存のルールを編集
4. アクションのドロップダウンで時間枠を設定（1時間、24時間、7日間など）

## ルール条件

カスタムルールでは、以下の条件を使用できます：

### リクエスト属性
- パス
- クエリ文字列
- メソッド
- ヘッダー
- Cookie
- ユーザーエージェント

### ネットワーク属性
- IPアドレス
- 国
- ASN（Autonomous System Number）

### TLS属性
- JA3指紋
- JA4指紋

### 演算子
- 等しい（Equals）
- 含む（Contains）
- 正規表現（Regex）
- 開始する（Starts with）
- 終了する（Ends with）

## ベストプラクティス

1. **ログアクションで開始**: ルールを最初にログアクションで作成し、10分間のライブトラフィックで影響を確認
2. **段階的な適用**: 確認後、チャレンジまたは拒否アクションに変更
3. **明確な命名**: ルールの目的を明確に示す名前を付ける
4. **ドキュメント化**: 各ルールの目的と条件を記録

## カスタムルールの例

### 特定のパスを保護

```
IF path equals /admin
THEN deny
```

### 特定の国からのアクセスをブロック

```
IF country equals CN
THEN deny
```

### APIエンドポイントのレート制限

```
IF path starts with /api
THEN rate limit (100 requests per minute)
```

### 疑わしいユーザーエージェントをチャレンジ

```
IF user-agent contains "bot"
THEN challenge
```

### 既知の良いボットをバイパス

```
IF user-agent contains "Googlebot"
THEN bypass
```

## 制限事項

- プロジェクトごとの最大ルール数は、プランによって異なります
- 複雑な正規表現は、パフォーマンスに影響を与える可能性があります
- すべての条件は AND で結合されます

詳細な例は[Examples](/docs/security/vercel-waf/examples)を参照してください。
