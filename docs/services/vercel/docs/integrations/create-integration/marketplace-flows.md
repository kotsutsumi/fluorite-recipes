# ネイティブ統合フロー

Vercelの統合プロバイダーとして、[ネイティブ製品統合](/docs/integrations/marketplace-product)を作成する際は、[統合サーバー](https://github.com/vercel/example-marketplace-integration)を設定し、[Vercelマーケットプレイス REST API](/docs/integrations/marketplace-api)を使用して、統合ユーザーと製品間の対話を管理する必要があります。

以下の図は、統合ユーザーとVercelダッシュボード間の主要な対話における、情報の双方向フローを理解するのに役立ちます。

## ストレージ製品フローの作成

Vercelユーザーがストレージタブからデータベースを作成する際、プロバイダーがユーザー向けに製品を作成するために必要な主要な情報を提供するステップを経ます。

フロー図を確認した後、各ステップのシーケンスを探ってみましょう：

- [ストレージ製品の選択](#ストレージ製品の選択)
- [課金プランの選択](#課金プランの選択)
- [ストア作成の送信](#ストア作成の送信)

### ストレージ製品の選択

統合ユーザーがストレージプロバイダー製品を選択すると、そのユーザー用のアカウントがプロバイダー側に作成されます（まだ存在しない場合）。その場合、ユーザーには利用規約の承認モーダルが表示されます。

**フロー**:
1. ユーザーがVercelダッシュボードの「ストレージ」タブで製品を選択
2. Vercelが統合サーバーの `/marketplace/account` エンドポイントを呼び出し
3. 統合サーバーがユーザーアカウントを作成（存在しない場合）
4. ユーザーに利用規約の承認を求める
5. ユーザーが承認すると、次のステップに進む

### 課金プランの選択

この製品と統合ユーザーのインストールIDを使用して、Vercelダッシュボードは利用可能な課金プランを取得します。

**フロー**:
1. Vercelが統合サーバーの `/marketplace/plans` エンドポイントを呼び出し
2. 統合サーバーが利用可能なプランのリストを返す：
   ```typescript
   {
     "plans": [
       {
         "id": "free",
         "name": "Free",
         "price": 0,
         "features": ["5 GB ストレージ", "100 リクエスト/日"]
       },
       {
         "id": "pro",
         "name": "Pro",
         "price": 2000,
         "features": ["100 GB ストレージ", "無制限リクエスト"]
       }
     ]
   }
   ```
3. ユーザーがプランを選択

### ストア作成の送信

ユーザーがすべての必要な情報を入力し、「作成」をクリックすると、Vercelは統合サーバーにリソース作成リクエストを送信します。

**フロー**:
1. Vercelが統合サーバーの `/marketplace/resources` エンドポイントにPOSTリクエストを送信
2. リクエストには以下が含まれます：
   ```typescript
   {
     "teamId": "team_xxx",
     "installationId": "installation_xxx",
     "productId": "database",
     "planId": "pro",
     "configuration": {
       "name": "my-database",
       "region": "us-east-1"
     }
   }
   ```
3. 統合サーバーがリソースをプロビジョニング
4. リソース詳細と環境変数を返す：
   ```typescript
   {
     "resourceId": "resource_xxx",
     "status": "active",
     "environmentVariables": [
       {
         "key": "DATABASE_URL",
         "value": "postgresql://...",
         "target": ["production", "preview", "development"]
       }
     ]
   }
   ```

## プロジェクトへのリソース接続フロー

リソースが作成された後、ユーザーはそれをプロジェクトに接続できます。

**フロー**:
1. ユーザーがリソースの詳細ページで「プロジェクトに接続」を選択
2. 接続するプロジェクトを選択
3. Vercelが統合サーバーの `/marketplace/resources/:id/connect` エンドポイントを呼び出し：
   ```typescript
   {
     "projectId": "prj_xxx",
     "resourceId": "resource_xxx"
   }
   ```
4. 統合サーバーが環境変数をプロジェクトに追加
5. 接続が確立されたことを確認

## リソース削除フロー

ユーザーがリソースを削除すると、Vercelは統合サーバーに通知します。

**フロー**:
1. ユーザーがリソースの詳細ページで「削除」を選択
2. 削除の確認ダイアログを表示
3. ユーザーが確認すると、Vercelが統合サーバーの `/marketplace/resources/:id` エンドポイントにDELETEリクエストを送信
4. 統合サーバーがリソースを削除し、関連するすべてのデータをクリーンアップ
5. 環境変数がプロジェクトから削除される
6. 削除が完了したことを確認

## 課金更新フロー

ユーザーがプランをアップグレードまたはダウングレードすると、Vercelは統合サーバーに通知します。

**フロー**:
1. ユーザーがリソースの設定ページで「プランを変更」を選択
2. 新しいプランを選択
3. Vercelが統合サーバーの `/marketplace/resources/:id/plan` エンドポイントにPATCHリクエストを送信：
   ```typescript
   {
     "resourceId": "resource_xxx",
     "newPlanId": "enterprise"
   }
   ```
4. 統合サーバーがプランを更新
5. 更新されたリソース情報を返す

## エラーハンドリング

すべてのフローで適切なエラーハンドリングを実装してください：

```typescript
{
  "error": {
    "code": "RESOURCE_CREATION_FAILED",
    "message": "リソースの作成に失敗しました",
    "details": "リージョン 'us-west-1' は現在利用できません"
  }
}
```

## ベストプラクティス

- **レスポンスタイム**: APIレスポンスは3秒以内に返す
- **冪等性**: すべてのAPI操作は冪等であるべき
- **検証**: すべての入力を適切に検証
- **セキュリティ**: すべての通信でHTTPSを使用
- **ログ**: すべての操作を詳細にログに記録
- **モニタリング**: API のパフォーマンスと可用性を監視
