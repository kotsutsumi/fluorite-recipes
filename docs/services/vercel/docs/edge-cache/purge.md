# Cache Purge（キャッシュパージ）

キャッシュパージは、Vercelのエッジキャッシュをクリアまたは無効化するための機能です。

## キャッシュキー

VercelのCDNへの各リクエストには、以下の要素から派生したキャッシュキーがあります:

- リクエストメソッド（GET、HEADなど）
- リクエストURL
- ホストドメイン
- 一意のデプロイメントURL
- スキーム（https/http）

## キャッシュパージの理解

### Invalidating the Cache（キャッシュの無効化）

**動作**:
- キャッシュされたコンテンツを「古い」とマーク
- 次のリクエストで古いコンテンツを即座に配信
- バックグラウンドで再検証が実行される
- ユーザーへのレイテンシ影響なし

**利点**:
- ユーザーエクスペリエンスの維持
- スムーズなコンテンツ更新

### Deleting the Cache（キャッシュの削除）

**動作**:
- キャッシュエントリを削除対象としてマーク
- 次のリクエストでオリジンからコンテンツを取得
- 最初のリクエストが遅くなる可能性
- 「キャッシュスタンピード」のリスク

**注意事項**:
- 複数の同時リクエストがある場合、オリジンサーバーに過負荷がかかる可能性

## キャッシュタグ

**特性**:
- 大文字と小文字を区別
- プロジェクトにスコープされる
- 本番またはプレビューデプロイメントを対象可能

## 手動でのキャッシュパージ

### ダッシュボードからのパージ

1. プロジェクトのSettingsに移動
2. Cachesを選択
3. "Purge CDN Cache"をクリック
4. パージ方法を選択:
   - **Invalidate（推奨）**: バックグラウンドで再検証
   - **Delete**: フォアグラウンドで再検証

### パージ方法の選択

#### Invalidate（無効化）

**推奨される理由**:
- ユーザーへの影響が最小限
- 即座に古いコンテンツを配信
- バックグラウンドで更新

**使用ケース**:
- 通常のコンテンツ更新
- 頻繁なパージが必要な場合

#### Delete（削除）

**使用ケース**:
- セキュリティ上の理由で即座に削除が必要
- 古いコンテンツを絶対に配信したくない場合

**注意点**:
- パフォーマンスへの影響
- キャッシュスタンピードのリスク

## 制限事項

### プラン別の制限

| プラン | REST API呼び出し/分 | タグ数/呼び出し | タグ文字数制限 | タグ数/キャッシュレスポンス |
|-------|------------------|--------------|--------------|----------------------|
| Hobby | 5 | 16 | 256 | 128 |
| Pro | 5 | 16 | 256 | 128 |
| Enterprise | 5 | 16 | 256 | 128 |

### その他の制限

- **API呼び出し頻度**: 1分あたり5回まで
- **同時タグ数**: 1回の呼び出しあたり16個まで
- **タグ文字数**: 最大256文字
- **レスポンスあたりのタグ数**: 最大128個

## API経由のキャッシュパージ

### キャッシュタグの設定

```typescript
export async function GET() {
  return new Response('Content', {
    status: 200,
    headers: {
      'Cache-Control': 's-maxage=3600',
      'Cache-Tag': 'blog-posts,homepage',
    },
  });
}
```

### キャッシュタグによるパージ（REST API）

```bash
curl -X PURGE \
  -H "Authorization: Bearer $VERCEL_TOKEN" \
  "https://api.vercel.com/v1/purge?tags=blog-posts"
```

## パージイベントの影響

キャッシュパージイベントは、以下のリソース使用量を一時的に増加させる可能性があります:

### 1. Function Invocations（関数呼び出し）

キャッシュミスにより、関数の呼び出しが増加します。

### 2. Fast Data Transfer（高速データ転送）

再キャッシュのためのデータ転送が増加します。

### 3. Fast Origin Transfer（高速オリジン転送）

オリジンサーバーとのデータ転送が増加します。

### 4. Edge Requests（エッジリクエスト）

エッジでのリクエスト処理が増加します。

## ベストプラクティス

### 1. Invalidateを優先

通常の状況では、Invalidate（無効化）を使用してください。

**理由**:
- ユーザーエクスペリエンスの維持
- パフォーマンスへの影響が最小限

### 2. キャッシュタグの戦略的な使用

```typescript
// コンテンツタイプ別にタグを設定
export async function GET() {
  return new Response('Blog Post', {
    headers: {
      'Cache-Tag': 'content,blog,post-123',
    },
  });
}
```

### 3. パージ頻度の管理

API呼び出し制限（1分あたり5回）を考慮し、パージを戦略的にバッチ処理します。

### 4. タグの命名規則

```
// 推奨される命名規則
content-type:blog
resource:post-123
category:technology
author:john-doe
```

### 5. パージのモニタリング

パージイベント後のリソース使用量を監視し、必要に応じて調整します。

## トラブルシューティング

### キャッシュが更新されない

1. タグが正しく設定されているか確認
2. API呼び出し制限を超えていないか確認
3. キャッシュキーが正しいか確認

### パフォーマンスの低下

1. Invalidateの代わりにDeleteを使用していないか確認
2. パージ頻度を確認
3. キャッシュタグの粒度を調整

## まとめ

キャッシュパージを適切に使用することで、コンテンツの鮮度を保ちながら、高いパフォーマンスを維持できます。通常の状況ではInvalidate（無効化）を使用し、セキュリティ上の理由がある場合のみDelete（削除）を使用してください。
