# Vercel Agent Usage - 使用方法

## 概要

Vercel Agentは、リポジトリのプルリクエストを自動的にレビューし、詳細な使用状況メトリクスを提供します。このページでは、Vercel Agentの使用方法と使用状況の監視について説明します。

## リポジトリのレビュー設定

### レビュー対象の選択

Vercel Agentは、Vercelプロジェクトに接続されたリポジトリのプルリクエストをレビューします。以下のオプションから選択できます：

#### 1. すべてのリポジトリ（デフォルト）

- Vercelに接続されているすべてのリポジトリでVercel Agentが有効
- 新しいリポジトリも自動的に対象に含まれる
- 最も包括的なカバレッジ

**設定方法**:
1. Vercelダッシュボードで「Agent」タブに移動
2. 「リポジトリ設定」セクションを見つける
3. 「すべてのリポジトリ」を選択
4. 「保存」をクリック

#### 2. 公開リポジトリのみ

- 公開リポジトリのみでVercel Agentが動作
- プライベートリポジトリは対象外
- オープンソースプロジェクトに最適

**設定方法**:
1. 「Agent」タブに移動
2. 「リポジトリ設定」セクションを見つける
3. 「公開リポジトリのみ」を選択
4. 「保存」をクリック

#### 3. プライベートリポジトリのみ

- プライベートリポジトリのみでVercel Agentが動作
- 公開リポジトリは対象外
- 社内プロジェクトに最適

**設定方法**:
1. 「Agent」タブに移動
2. 「リポジトリ設定」セクションを見つける
3. 「プライベートリポジトリのみ」を選択
4. 「保存」をクリック

### ドラフトPRのレビュー設定

ドラフトプルリクエストをレビュー対象に含めるかを設定できます：

#### ドラフトPRレビューを有効化

**メリット**:
- 早期のフィードバック
- 開発中の問題を早期発見
- レビュープロセスの効率化

**設定方法**:
1. 「Agent」タブに移動
2. 「ドラフトPRのレビュー」トグルを有効化
3. 「保存」をクリック

#### ドラフトPRレビューを無効化（デフォルト）

**メリット**:
- レビューコストの削減
- 完成したコードのみレビュー
- ノイズの削減

**設定方法**:
1. 「Agent」タブに移動
2. 「ドラフトPRのレビュー」トグルを無効化
3. 「保存」をクリック

## レビューと支出の監視

### 使用状況ダッシュボード

Vercel Agentの使用状況は、「Agent」タブで確認できます：

#### 表示される情報

| 項目 | 説明 |
|-----|------|
| リポジトリ名 | レビューされたリポジトリ |
| 提案の数 | Agentが行った修正提案の数 |
| レビュー時間 | レビューにかかった時間 |
| 分析されたファイル数 | 分析されたファイルの数 |
| レビューコスト | レビューにかかった費用 |
| プルリクエスト識別子 | PR番号またはURL |
| レビュー時刻 | レビューが実行された日時 |

### フィルタリングとソート

使用状況データは、以下の条件でフィルタリング・ソートできます：

#### フィルタリング

- **リポジトリ**: 特定のリポジトリのみ表示
- **日付範囲**: 特定期間のレビューのみ表示
- **コスト範囲**: 特定のコスト範囲のレビューのみ表示

#### ソート

- **日付**: 新しい順/古い順
- **コスト**: 高い順/低い順
- **ファイル数**: 多い順/少ない順
- **提案数**: 多い順/少ない順

### コスト内訳

各レビューのコストは、以下のように内訳が表示されます：

```
レビューコスト: $0.85
├─ 固定費: $0.30
└─ トークンコスト: $0.55
    ├─ 入力トークン: $0.25 (5,000トークン)
    └─ 出力トークン: $0.30 (3,000トークン)
```

### 月次サマリー

月次サマリーでは、以下の情報が確認できます：

- **総レビュー数**: 今月のレビュー回数
- **総コスト**: 今月の総費用
- **平均コスト**: レビュー1回あたりの平均費用
- **総ファイル数**: 分析された総ファイル数
- **総提案数**: 行われた総提案数

## データのエクスポート

### CSVエクスポート

使用状況データをCSV形式でエクスポートできます：

#### エクスポート手順

1. 「Agent」タブに移動
2. 「エクスポート」ボタンをクリック
3. 日付範囲を選択（オプション）
4. 「エクスポート」を確認
5. CSVファイルがダウンロードされる

#### CSVファイルの内容

エクスポートされるCSVファイルには、以下の列が含まれます：

```csv
Timestamp,Repository,PR Number,Files Analyzed,Suggestions,Review Time,Fixed Cost,Token Cost,Total Cost
2024-01-15 10:30:00,my-repo,123,25,8,45s,$0.30,$0.55,$0.85
2024-01-16 14:20:00,my-repo,124,18,5,30s,$0.30,$0.40,$0.70
...
```

### エクスポートの用途

- **会計/請求**: 費用の追跡と予算管理
- **分析**: データ分析ツールでの詳細分析
- **レポート**: 経営層への報告資料作成
- **監査**: コンプライアンス監査用の記録

## 支出管理

### 予算設定

月次予算を設定して、支出を管理できます：

#### 予算アラートの設定

1. 「Agent」タブに移動
2. 「予算設定」セクションを見つける
3. 月次予算額を入力（例：$500）
4. アラート閾値を設定（例：80%）
5. 「保存」をクリック

#### アラート通知

予算の80%、90%、100%に達すると、以下の方法で通知されます：

- **メール通知**: 登録されたメールアドレスに通知
- **ダッシュボード通知**: Vercelダッシュボードに表示
- **Slack通知**: Slack統合を設定している場合

### 支出制限

予算を超えた場合の動作を設定できます：

#### オプション1: 警告のみ

- 予算を超えてもレビューを継続
- 警告通知のみ受信

#### オプション2: レビュー一時停止

- 予算を超えるとレビューを一時停止
- 次月まで、または予算を増額するまで停止

**設定方法**:
1. 「Agent」タブ > 「予算設定」
2. 「予算超過時の動作」を選択
3. 「保存」をクリック

## コスト最適化

### 1. レビュー対象の最適化

不要なリポジトリやファイルをレビュー対象から除外：

#### リポジトリの除外

```yaml
# .vercel/agent.yml
excludeRepositories:
  - legacy-project
  - archived-repo
```

#### ファイルの除外

```yaml
# .vercel/agent.yml
excludeFiles:
  - "**/*.test.js"  # テストファイルを除外
  - "**/dist/**"    # ビルド出力を除外
  - "**/*.min.js"   # ミニファイされたファイルを除外
```

### 2. レビュー頻度の調整

ドラフトPRのレビューを無効化して、完成したPRのみレビュー：

- コストを約30-50%削減可能
- レビューの質は維持

### 3. PRサイズの管理

大きなPRは、複数の小さなPRに分割：

- レビューコストの削減
- レビューの精度向上
- 開発プロセスの改善

**推奨PRサイズ**:
- 最大500行の変更
- 最大20ファイル

## レビュー結果の確認

### プルリクエストでのレビュー

Vercel Agentは、PR内で直接レビュー結果を提示します：

#### レビューコメント

```
🤖 Vercel Agent

問題: Null参照エラーの可能性
ファイル: src/components/UserProfile.tsx
行: 42

詳細:
`user.profile`がnullまたはundefinedの場合、エラーが発生します。

提案:
オプショナルチェーンを使用してください：

```typescript
const name = user?.profile?.name ?? 'Unknown';
```

理由:
- Null参照エラーを防ぐ
- より安全なコード
- 可読性の向上
```

#### アクション

開発者は、以下のアクションを取ることができます：

1. **Commit suggestion**: 提案をそのまま適用
2. **Reply**: コメントで議論
3. **Dismiss**: 提案を却下

### ダッシュボードでのレビュー

Vercelダッシュボードでも、レビュー結果の詳細を確認できます：

1. 「Agent」タブに移動
2. レビュー履歴から確認したいPRを選択
3. 詳細ページで以下を確認：
   - すべての提案
   - 分析されたファイル
   - 検出された問題の種類
   - レビューコスト

## 統合とAPI

### Webhook通知

Vercel Agentのレビュー完了時にWebhook通知を受け取ることができます：

#### Webhookの設定

1. プロジェクト設定に移動
2. 「Webhooks」セクションを選択
3. 「Add Webhook」をクリック
4. エンドポイントURLを入力
5. 「Agent Review Completed」イベントを選択
6. 「保存」をクリック

#### Webhookペイロード

```json
{
  "type": "agent.review.completed",
  "createdAt": 1705320000000,
  "data": {
    "repository": "my-org/my-repo",
    "pullRequest": 123,
    "suggestions": 8,
    "filesAnalyzed": 25,
    "cost": 0.85,
    "reviewTime": 45
  }
}
```

### REST API

プログラマティックに使用状況データを取得できます：

```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "https://api.vercel.com/v1/agent/usage?teamId=YOUR_TEAM_ID&from=2024-01-01&to=2024-01-31"
```

**レスポンス**:
```json
{
  "reviews": [
    {
      "id": "rev_xxxxxxxxxxxxx",
      "repository": "my-org/my-repo",
      "pullRequest": 123,
      "suggestions": 8,
      "filesAnalyzed": 25,
      "cost": 0.85,
      "createdAt": 1705320000000
    }
  ],
  "totalCost": 25.50,
  "totalReviews": 30
}
```

## トラブルシューティング

### 問題1: レビューが実行されない

**確認事項**:
- [ ] Vercel Agentが有効化されているか
- [ ] リポジトリがレビュー対象に含まれているか
- [ ] PRがドラフトで、ドラフトPRレビューが無効化されていないか

**解決策**:
1. Agent設定を確認
2. リポジトリ設定を確認
3. 手動でレビューをトリガー

### 問題2: レビューコストが予想より高い

**原因**:
- PRサイズが大きい
- 複雑なコード変更
- 多数のファイルが含まれる

**解決策**:
1. PRを複数の小さなPRに分割
2. 不要なファイルを除外
3. レビュー対象を最適化

### 問題3: 提案が表示されない

**確認事項**:
- [ ] PRに問題がないか（すでに最適化されている可能性）
- [ ] レビューが完了しているか
- [ ] GitHub権限が正しく設定されているか

**解決策**:
1. レビュー履歴で確認
2. GitHub統合を再接続
3. Vercelサポートに連絡

## ベストプラクティス

### 1. 定期的な使用状況の確認

- 週次または月次で使用状況を確認
- 予算との比較
- コスト最適化の機会を特定

### 2. チームへの共有

- レビュー結果をチームで共有
- ベストプラクティスを文書化
- 継続的な改善

### 3. フィードバックの提供

Vercel Agentの提案に対するフィードバックを提供：

- 有用な提案には「👍」
- 不適切な提案には理由を説明
- Vercelサポートにフィードバック

### 4. 統合ワークフロー

Vercel Agentを既存のレビュープロセスに統合：

1. Vercel Agentがレビュー
2. 自動テストが実行
3. 人間のレビュアーが最終確認
4. マージ

## 関連リソース

- [Vercel Agent概要](/docs/agent/overview)
- [AI SDK](/docs/ai-sdk)
- [Webhooks](/docs/webhooks)
- [REST API](/docs/api)
- [コスト最適化](/docs/cost-optimization)
