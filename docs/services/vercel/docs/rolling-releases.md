# ローリングリリース

## 概要

ローリングリリースは、[Enterprise](/docs/plans/enterprise)および[Pro](/docs/plans/pro)プランで利用可能な機能です。

ローリングリリースにより、新しいデプロイメントを段階的にユーザーに展開できます：

- 新しいデプロイメントを即座に100%のトラフィックに公開するのではなく、設定可能な割合（例：5%）のユーザーにのみ提供します
- 残りのトラフィックは、以前の本番デプロイメントにルーティングされます
- メトリクスを監視しながら、徐々にトラフィックの割合を増やすことができます

## 主な特徴

### 段階的なロールアウト

- デプロイメントを徐々に展開
- Vercelは、選択した割合のトラフィックを新しいデプロイメントに誘導
- メトリクスを比較して、新しいデプロイメントの安定性を評価可能

### 観測性

- [Speed Insights](/docs/speed-insights)などのメトリクスで新旧デプロイメントを比較
- デプロイメントページで現在のローリングリリースステータスを確認
- エラー率、パフォーマンス、ユーザー体験を監視

### 高度な制御

- 複数のステージを設定可能（5% → 25% → 50% → 100%）
- いつでもロールバックまたは次のステージに進むことができる
- [Skew Protection](/docs/skew-protection)と組み合わせて、一貫性を確保

## ローリングリリースの仕組み

### 基本的なフロー

1. **新しいデプロイメントの作成**
   - コードをプッシュしてデプロイメントを作成

2. **初期ロールアウト**
   - 例：5%のトラフィックを新しいデプロイメントに送信
   - 95%は現在の本番デプロイメントに送信

3. **メトリクスの監視**
   - エラー率、パフォーマンス、ユーザーフィードバックを確認

4. **段階的な増加**
   - 問題がなければ、トラフィックの割合を増やす
   - 例：5% → 25% → 50% → 100%

5. **完全なロールアウトまたはロールバック**
   - 成功した場合：100%にロールアウト
   - 問題が発生した場合：ロールバック

### トラフィック分散

Vercelは、以下の方法でトラフィックを分散します：

- **Cookie ベース**：同じユーザーは一貫して同じバージョンを表示
- **ランダム分散**：新規ユーザーはランダムに割り当てられる

## 設定方法

### 1. プロジェクト設定でローリングリリースを有効化

1. Vercelダッシュボードでプロジェクトを選択
2. 「Settings」タブに移動
3. 「Build & Deployment」セクションを選択
4. 「Rolling Releases」を有効化

### 2. リリースステージの設定

リリースの段階を定義します：

```
ステージ1: 5%
ステージ2: 25%
ステージ3: 50%
ステージ4: 100%
```

### 3. デプロイメントの作成

通常どおりコードをプッシュしてデプロイメントを作成します：

```bash
git push origin main
```

### 4. ローリングリリースの開始

1. Vercelダッシュボードでデプロイメントを選択
2. 「Start Rolling Release」ボタンをクリック
3. 初期トラフィック割合を選択（例：5%）

### 5. メトリクスの監視

1. デプロイメントページで新旧バージョンのメトリクスを比較
2. Speed Insightsでパフォーマンスを確認
3. エラー追跡ツールでエラー率を監視

### 6. ロールアウトの進行またはロールバック

**次のステージに進む：**

```
現在: 5% → 次: 25%
```

1. 「Increase Traffic」ボタンをクリック
2. 新しい割合を選択
3. 確認して実行

**ロールバック：**

```
現在: 25% → ロールバック: 0%
```

1. 「Rollback」ボタンをクリック
2. 確認してロールバック
3. すべてのトラフィックが以前のバージョンに戻る

## 使用例

### 例1：新機能の段階的リリース

```
シナリオ: 新しい決済機能を追加

ステージ1（5%）:
  - 初期テスト
  - クリティカルなバグがないか確認

ステージ2（25%）:
  - エラー率が低いことを確認
  - パフォーマンスが許容範囲内

ステージ3（50%）:
  - ビジネスメトリクスを監視
  - コンバージョン率の変化を確認

ステージ4（100%）:
  - すべてのメトリクスが良好
  - 完全なロールアウト
```

### 例2：パフォーマンス改善のテスト

```
シナリオ: 画像最適化の実装

ステージ1（10%）:
  - Speed Insightsでページロード時間を比較
  - 新バージョン: 1.2秒、旧バージョン: 2.5秒

ステージ2（50%）:
  - より大きなサンプルサイズでテスト
  - パフォーマンス改善が一貫していることを確認

ステージ3（100%）:
  - すべてのユーザーに展開
```

## Skew Protectionとの統合

[Skew Protection](/docs/skew-protection)を有効にすると、クライアントとサーバーのバージョンの整合性を保証します。

### 設定方法

1. Skew Protectionを有効化
2. ローリングリリースを設定
3. 両方が自動的に連携

### 動作

- ユーザーが特定のバージョンに割り当てられると、セッション中は同じバージョンを使用
- クライアント側のコードとサーバー側のコードのバージョンが一致
- バージョンスキューによるエラーを防止

## メトリクスと監視

### Speed Insights

新旧デプロイメントのパフォーマンスを比較：

- **ページロード時間**
- **First Contentful Paint (FCP)**
- **Largest Contentful Paint (LCP)**
- **Cumulative Layout Shift (CLS)**

### エラー追跡

エラー率を監視：

- 新バージョンのエラー率が許容範囲内か確認
- エラーの種類と頻度を分析
- 必要に応じてロールバック

### カスタムメトリクス

独自のメトリクスを追跡：

```javascript
// カスタムイベントの送信
if (window.va) {
  window.va('event', {
    name: 'checkout_completed',
    data: {
      version: 'v2',
      amount: 99.99
    }
  });
}
```

## ベストプラクティス

### 1. 小さな割合から始める

初期ロールアウトは5〜10%程度にして、リスクを最小化：

```
推奨: 5% → 25% → 50% → 100%
避ける: 50% → 100%（リスクが高い）
```

### 2. 十分な監視期間を設ける

各ステージで十分なデータを収集：

- 最低でも数時間〜1日
- トラフィックパターンに応じて調整
- ピーク時間を含めて評価

### 3. 明確なロールバック基準を設定

事前にロールバック基準を定義：

```
ロールバック条件:
  - エラー率が5%以上増加
  - ページロード時間が20%以上悪化
  - コンバージョン率が10%以上低下
```

### 4. チーム内での通知

ローリングリリースの状態をチームに通知：

- Slackインテグレーションを使用
- ステージの変更を自動通知
- 問題発生時にアラート

### 5. ドキュメント化

各ローリングリリースを記録：

```markdown
# リリースログ

## 2024-01-15: 新決済機能

- 初期ロールアウト（5%）: 10:00 - 正常
- 25%に増加: 14:00 - エラー率正常
- 50%に増加: 翌日10:00 - パフォーマンス良好
- 100%完了: 翌日18:00
```

## トラブルシューティング

### トラフィックが分散されない

**原因：** ローリングリリースが正しく設定されていない

**解決策：**

1. プロジェクト設定でローリングリリースが有効か確認
2. デプロイメントでローリングリリースが開始されているか確認
3. Cookieが有効になっているか確認

### メトリクスが表示されない

**原因：** Speed Insightsが有効になっていない

**解決策：**

1. Speed Insightsをプロジェクトで有効化
2. `@vercel/speed-insights`パッケージをインストール
3. コンポーネントに統合

```bash
npm install @vercel/speed-insights
```

```javascript
import { SpeedInsights } from '@vercel/speed-insights/next';

export default function App({ Component, pageProps }) {
  return (
    <>
      <Component {...pageProps} />
      <SpeedInsights />
    </>
  );
}
```

### ロールバックできない

**原因：** 以前のデプロイメントが削除された

**解決策：**

1. 以前のデプロイメントが存在することを確認
2. 必要に応じて、以前のコミットから新しいデプロイメントを作成
3. 保持ポリシーを確認

## セキュリティとプライバシー

### ユーザーの割り当て

- ユーザーはCookieベースで割り当てられます
- 個人を特定できる情報（PII）は使用されません
- GDPR準拠

### データの分離

- 各バージョンのメトリクスは個別に追跡
- データの混在を防止

## 関連リンク

- [Skew Protection](/docs/skew-protection)
- [Speed Insights](/docs/speed-insights)
- [デプロイメント](/docs/deployments)
- [Proプラン](/docs/plans/pro)
- [Enterpriseプラン](/docs/plans/enterprise)
