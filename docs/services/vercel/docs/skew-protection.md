# スキュー保護

## 概要

スキュー保護は、[エンタープライズ](/docs/plans/enterprise)および[Pro](/docs/plans/pro)プランで利用可能な機能です。

[バージョンスキュー](https://www.industrialempathy.com/posts/version-skew/)は、クライアントとサーバーで異なるバージョンのアプリケーションが実行されることで発生し、アプリケーションエラーや予期せぬ動作を引き起こす可能性があります。

Vercelのスキュー保護は、[バージョンロック](https://www.industrialempathy.com/posts/version-skew/#version-locking)を使用して、クライアントとサーバーが同じバージョンを使用することを保証します。

## バージョンスキューとは

### 問題の例

1. ユーザーがページを読み込む（バージョンA）
2. 新しいデプロイメントが本番環境にプッシュされる（バージョンB）
3. ユーザーがページ遷移やAPIリクエストを行う
4. サーバーはバージョンBで応答
5. クライアント（バージョンA）とサーバー（バージョンB）の不一致によりエラーが発生

### 典型的なエラー

- **APIエンドポイントの変更**：クライアントが存在しないエンドポイントを呼び出す
- **データ構造の変更**：クライアントが期待しない形式のデータを受信
- **JavaScriptチャンクの不一致**：クライアントが存在しないチャンクを要求
- **ルーティングの変更**：クライアントが存在しないルートに遷移しようとする

## スキュー保護の仕組み

### バージョンロック

スキュー保護は、以下の方法でバージョンの整合性を保証します：

1. **Cookieベースのルーティング**
   - ユーザーの初回訪問時に、デプロイメントIDをCookieに保存
   - 以降のリクエストは、同じデプロイメントにルーティング

2. **自動的な同期**
   - クライアントとサーバーのすべてのリクエストが同じバージョンを使用
   - ページ遷移、API呼び出し、静的アセットのリクエストに適用

3. **段階的な移行**
   - 新しいユーザーは新しいバージョンを取得
   - 既存のセッションは古いバージョンを継続使用
   - ユーザーがページをリロードするまで、または最大経過時間に達するまで

## スキュー保護の有効化

### 新しいプロジェクト

2024年11月19日以降に作成されたプロジェクトは、デフォルトでスキュー保護が有効になっています。

### 既存のプロジェクト

古いプロジェクトの場合、プロジェクトの設定で有効化できます：

#### 有効化の手順

1. `--prebuilt`コマンドを使用していないことを確認
2. Vercelダッシュボードでプロジェクトを選択
3. 上部メニューの「Settings」タブを選択
4. サイドメニューの「Advanced」タブを選択
5. 「Skew Protection」のスイッチを有効にする
6. Enterpriseチームの場合、カスタムの最大経過時間を設定可能（デフォルト：2時間）

### 最大経過時間の設定

**最大経過時間**は、ユーザーが古いバージョンを使用できる最大時間です。

- **デフォルト**：2時間
- **Enterpriseプラン**：1時間〜24時間の間でカスタマイズ可能

期限切れになると、ユーザーは自動的に最新バージョンにリダイレクトされます。

## サポートされているフレームワーク

スキュー保護が追加設定なしで利用可能なフレームワーク：

- **Next.js**
- **SvelteKit**
- **Qwik**
- **Astro**
- **Nuxt**（近日対応予定）

### その他のフレームワーク

上記以外のフレームワークでも、手動で統合可能です。詳細は[カスタム統合](#カスタム統合)を参照してください。

## 使用例

### Next.jsでの使用

Next.jsプロジェクトでは、スキュー保護は自動的に機能します：

```javascript
// 特別な設定は不要
// Vercelが自動的にスキュー保護を適用
```

#### App Routerの場合

```javascript
// app/layout.js
export default function RootLayout({ children }) {
  return (
    <html lang="ja">
      <body>{children}</body>
    </html>
  );
}
```

#### Pages Routerの場合

```javascript
// pages/_app.js
export default function App({ Component, pageProps }) {
  return <Component {...pageProps} />;
}
```

### SvelteKitでの使用

SvelteKitでも自動的に機能します：

```javascript
// +layout.svelte
<script>
  // スキュー保護は自動的に適用される
</script>

<slot />
```

## カスタム統合

サポートされていないフレームワークでスキュー保護を使用する場合、手動で統合できます。

### 1. デプロイメントIDの取得

Vercelは、環境変数`VERCEL_DEPLOYMENT_ID`を提供します：

```javascript
const deploymentId = process.env.VERCEL_DEPLOYMENT_ID;
```

### 2. Cookieの設定

クライアントに送信するレスポンスにCookieを設定：

```javascript
// Node.js/Expressの例
app.use((req, res, next) => {
  if (!req.cookies._vercel_deployment_id) {
    res.cookie('_vercel_deployment_id', process.env.VERCEL_DEPLOYMENT_ID, {
      httpOnly: true,
      secure: true,
      sameSite: 'lax',
      maxAge: 7200000, // 2時間
    });
  }
  next();
});
```

### 3. リクエストのルーティング

すべてのリクエストが同じデプロイメントにルーティングされるようにします：

```javascript
// カスタムヘッダーの追加
app.use((req, res, next) => {
  if (req.cookies._vercel_deployment_id) {
    req.headers['x-deployment-id'] = req.cookies._vercel_deployment_id;
  }
  next();
});
```

## ローリングリリースとの統合

スキュー保護は、[ローリングリリース](/docs/rolling-releases)と自動的に連携します。

### 動作

1. **ローリングリリース開始**
   - 例：5%のトラフィックを新バージョンに送信

2. **スキュー保護の適用**
   - 新バージョンに割り当てられたユーザーは、セッション中は新バージョンのみを使用
   - 旧バージョンに割り当てられたユーザーは、旧バージョンのみを使用

3. **一貫性の保証**
   - クライアントとサーバーのバージョンが常に一致
   - バージョンスキューによるエラーを防止

### 設定例

```
プロジェクト設定:
  - ローリングリリース: 有効
  - スキュー保護: 有効
  - 最大経過時間: 2時間

ローリングリリースステージ:
  - ステージ1: 5%
  - ステージ2: 25%
  - ステージ3: 50%
  - ステージ4: 100%
```

## メトリクスと監視

### デプロイメントの追跡

Vercelダッシュボードで、各デプロイメントへのトラフィック分散を確認できます：

1. プロジェクトの「Deployments」タブに移動
2. 各デプロイメントのトラフィック割合を表示
3. スキュー保護により、ユーザーがどのバージョンに固定されているか確認

### アクティブなセッション

各デプロイメントに固定されているアクティブなセッション数を監視：

- 古いバージョンに固定されているユーザー数
- 新しいバージョンに移行したユーザー数

## ベストプラクティス

### 1. 適切な最大経過時間の設定

アプリケーションの特性に応じて設定：

- **短時間（1時間）**：頻繁に更新されるアプリケーション
- **中時間（2時間、デフォルト）**：通常のアプリケーション
- **長時間（4〜24時間）**：長時間のセッションが一般的なアプリケーション

### 2. 後方互換性の維持

スキュー保護を使用していても、後方互換性は重要です：

```javascript
// APIエンドポイントの変更時
// 古いバージョンと新しいバージョンの両方をサポート
app.get('/api/users', (req, res) => {
  // 新しい形式
  if (req.query.version === 'v2') {
    return res.json({ users: [...] });
  }
  // 古い形式（互換性のため）
  return res.json([...]);
});
```

### 3. 段階的なロールアウト

大きな変更は、ローリングリリースと組み合わせて段階的に展開：

```
ステージ1（5%）:
  - スキュー保護により、5%のユーザーが新バージョンに固定
  - 問題を早期発見

ステージ2（25%）:
  - より多くのユーザーで検証

ステージ3（100%）:
  - 全ユーザーに展開
```

### 4. モニタリングとアラート

スキュー保護に関連するメトリクスを監視：

- 各バージョンのエラー率
- バージョン間のパフォーマンス差
- 古いバージョンに固定されているユーザーの数

## トラブルシューティング

### Cookieが保存されない

**原因：** ブラウザの設定またはプライバシーモード

**解決策：**

1. Cookieが`httpOnly`、`secure`、`sameSite`属性で正しく設定されているか確認
2. ユーザーにCookieを有効にするよう促す
3. フォールバックメカニズムを実装

### ユーザーが古いバージョンに固定される

**原因：** Cookieが期限切れになっていない

**解決策：**

1. 最大経過時間を確認
2. 必要に応じて、Cookieを手動でクリアするオプションを提供
3. ユーザーにページのリロードを促す

### バージョンスキューエラーが発生する

**原因：** スキュー保護が正しく設定されていない、またはフレームワークが未サポート

**解決策：**

1. プロジェクト設定でスキュー保護が有効か確認
2. サポートされているフレームワークを使用しているか確認
3. カスタム統合が必要な場合は、実装を確認

### デプロイメント間でデータの不一致

**原因：** データベーススキーマの変更が互換性がない

**解決策：**

1. データベースマイグレーションを段階的に実行
2. 古いバージョンと新しいバージョンの両方で動作するようにスキーマを設計
3. フィーチャーフラグを使用して、新機能を段階的に有効化

## セキュリティとプライバシー

### Cookieのセキュリティ

スキュー保護で使用されるCookieは、以下の属性で保護されています：

- **httpOnly**: JavaScriptからアクセス不可
- **secure**: HTTPS接続でのみ送信
- **sameSite**: CSRF攻撃を防止

### プライバシー

- デプロイメントIDのみが保存される
- 個人を特定できる情報（PII）は含まれない
- GDPR、CCPA準拠

## パフォーマンスへの影響

スキュー保護のパフォーマンスへの影響は最小限です：

- **追加レイテンシ**: ほぼゼロ（Cookieの読み書きのみ）
- **ストレージ**: 小さなCookie（数バイト）
- **ネットワーク**: 追加のリクエストは不要

## 関連リンク

- [ローリングリリース](/docs/rolling-releases)
- [デプロイメント](/docs/deployments)
- [Proプラン](/docs/plans/pro)
- [Enterpriseプラン](/docs/plans/enterprise)
- [バージョンスキューについて（外部リンク）](https://www.industrialempathy.com/posts/version-skew/)
