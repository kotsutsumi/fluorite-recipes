# Storage CDN

## 概要

Supabase Storageにアップロードされたすべてのアセットは、グローバルにレイテンシを改善するためにコンテンツデリバリーネットワーク(CDN)にキャッシュされます。CDNは、「オリジンサーバー」からコンテンツをキャッシュする地理的に分散された「ノード」を使用します。Supabase Storageの場合、オリジンはプロジェクトと同じリージョンにあるストレージサーバーです。

## 主な利点

- 世界中のユーザーのパフォーマンスを向上
- DDoS攻撃を軽減してセキュリティを強化
- 分散キャッシングによりレイテンシを削減

## ワークフローの例

1. シンガポールのプロジェクト用にバケットが作成されます
2. すべてのStorage APIリクエストは、まずCDNを経由してルーティングされます
3. 米国からの最初のユーザーリクエストは「キャッシュミス」となります
   - CDNノードはシンガポールのオリジンサーバーからオブジェクトを取得
4. 米国からの後続のユーザーリクエストは、米国のCDNキャッシュから直接提供されます

## キャッシュステータス

`cf-cache-status`ヘッダーはキャッシング動作を示します:
- `MISS`: オブジェクトがCDNキャッシュにない、オリジンから取得
- `HIT`: オブジェクトがCDNキャッシュから直接提供される

## パブリックバケット vs プライベートバケット

### パブリックバケット
- 認証不要
- より高いキャッシュヒット率
- 後続の取得が高速

### プライベートバケット
- ユーザーごとの権限チェック
- 個別のセキュリティポリシーによる潜在的なキャッシュミス
- パブリックバケットと比較してキャッシング効率が低い

このドキュメントは、特定のリージョンで最近リクエストされていない場合、CDNがキャッシュされたオブジェクトを削除する可能性があることを強調しています。

## CDNの仕組み

### コンテンツ配信プロセス

1. **ユーザーリクエスト**: ユーザーがストレージアセットをリクエスト
2. **CDNルーティング**: リクエストが最寄りのCDNノードにルーティング
3. **キャッシュチェック**: CDNノードがローカルキャッシュを確認
4. **キャッシュヒット/ミス**:
   - **ヒット**: コンテンツがキャッシュから直接提供
   - **ミス**: オリジンサーバーからコンテンツを取得し、今後のリクエストのためにキャッシュ

### キャッシュの削除

CDNノードは以下の場合にキャッシュされたコンテンツを削除する可能性があります:
- 一定期間リクエストがない場合
- キャッシュストレージ容量に達した場合
- 手動でキャッシュが無効化された場合

## パフォーマンスのベストプラクティス

### パブリックコンテンツの最適化

- 静的アセットにはパブリックバケットを使用
- 適切な`Cache-Control`ヘッダーを設定
- 頻繁にアクセスされるファイルをCDNエッジに近づける

### プライベートコンテンツの考慮事項

- プライベートバケットはユーザーごとに認証が必要
- 各リクエストが個別に検証される可能性があります
- セキュリティが最優先の場合に使用

### グローバルパフォーマンス

- CDNは自動的にコンテンツを世界中に配信
- 初回アクセス後、特定のリージョンでのレスポンスが大幅に改善
- ユーザーに最も近いエッジロケーションが自動的に選択

## キャッシュヘッダーの理解

### cf-cache-status の値

| ステータス | 説明 |
|-----------|------|
| `HIT` | コンテンツがCDNキャッシュから提供 |
| `MISS` | コンテンツがオリジンから取得 |
| `EXPIRED` | キャッシュされたコンテンツが期限切れ、再検証が必要 |
| `STALE` | 古いコンテンツが提供、バックグラウンドで更新中 |
| `BYPASS` | キャッシュがバイパスされ、直接オリジンから取得 |
| `REVALIDATED` | キャッシュされたコンテンツが再検証され、まだ有効 |

### レスポンスヘッダーの確認

```javascript
const response = await fetch('https://project-ref.supabase.co/storage/v1/object/public/bucket/file.jpg');
const cacheStatus = response.headers.get('cf-cache-status');
console.log('Cache Status:', cacheStatus);
```

## トラブルシューティング

### 低いキャッシュヒット率

- プライベートバケットの使用を確認(ヒット率が低くなる可能性)
- `Cache-Control`ヘッダー設定を確認
- ファイルパスが一貫していることを確認(パスが異なるとキャッシュミス)

### キャッシュの問題

- ファイルが頻繁に更新される場合、短いTTLを設定
- バージョン管理にクエリパラメータを使用
- Smart CDN機能を活用(Proプラン以上)
