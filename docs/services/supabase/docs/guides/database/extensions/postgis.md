# PostGIS: 地理空間クエリ

## 概要

PostGISは、地理空間データを扱うためのPostgres拡張機能です。主な機能：

- 地理座標の効率的な処理
- Point、Polygon、LineStringなどの特殊なデータ型
- スケーラブルな地理空間クエリとインデックス作成

## 拡張機能の有効化

PostGISを有効にするには：

1. Supabaseダッシュボードのデータベースページに移動
2. "Extensions"をクリック
3. "postgis"を検索して有効化
4. 新しいスキーマを作成（例："gis"）

## 使用例

### レストランテーブルの作成

```sql
create table if not exists public.restaurants (
    id int generated by default as identity primary key,
    name text not null,
    location gis.geography(POINT) not null
);

create index restaurants_geo_index
on public.restaurants
using GIST (location);
```

### 地理データの挿入

サンプルレストランデータ：
- Supa Burger: 緯度 40.807416, 経度 -73.946823
- Supa Pizza: 緯度 40.807475, 経度 -73.94581
- Supa Taco: 緯度 40.80629, 経度 -73.945826

### 地理空間データのクエリ

#### 距離順に並び替え

近接度でレストランをソートする関数を作成：

```sql
create or replace function nearby_restaurants(lat float, long float)
returns table (
    id int,
    name text,
    lat float,
    long float,
    dist_meters float
)
-- 関数の実装詳細
```

#### バウンディングボックス内のレストランを検索

特定の地理的エリア内のレストランを取得する関数を作成：

```sql
create or replace function restaurants_in_view(
    min_lat float,
    min_long float,
    max_lat float,
    max_long float
)
returns table (
    id int,
    name text,
    lat float,
    long float
)
-- 関数の実装詳細
```

## トラブルシューティング

PostGISのスキーマ再配置の問題については、公式ドキュメントを参照してください。
