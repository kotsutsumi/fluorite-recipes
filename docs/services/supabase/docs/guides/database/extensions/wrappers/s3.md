# AWS S3 Wrapper for Supabase

## 概要

AWS S3は、Postgresデータベース内でS3からデータを読み取ることができるオブジェクトストレージサービスです。S3 Wrapperは以下をサポートしています:

### サポートされているファイル形式
- CSV（ヘッダーあり/なし）
- JSON Lines
- Parquet

### サポートされている圧縮アルゴリズム
- gzip
- bzip2
- xz
- zlib

## 準備

### Wrappers拡張機能の有効化
```sql
create extension if not exists wrappers with schema extensions;
```

### S3 Wrapperの有効化
```sql
create foreign data wrapper s3_wrapper
  handler s3_fdw_handler
  validator s3_fdw_validator;
```

### 認証情報の保存（Vaultの使用を推奨）
```sql
select vault.create_secret(
  '<access key id>',
  's3_access_key_id',
  'AWS access key for Wrappers'
);
select vault.create_secret(
  '<secret access key>',
  's3_secret_access_key',
  'AWS secret access key for Wrappers'
);
```

### S3への接続
```sql
create server s3_server
  foreign data wrapper s3_wrapper
  options (
    vault_access_key_id '<your s3_access_key_id>',
    vault_secret_access_key '<your s3_secret_access_key>',
    aws_region 'us-east-1'
  );
```

### 必要なS3権限
- s3:GetObject
- s3:GetObjectAttributes

バージョン管理されたバケットの場合:
- s3:GetObjectVersion
- s3:GetObjectVersionAttributes

## 外部テーブルオプション

- `uri`: S3 URI（必須、例: `s3://bucket/s3_table.csv`）
- `format`: ファイル形式（必須: `csv`, `jsonl`, `parquet`）
- `has_header`: CSVヘッダーオプション（オプション、デフォルト `false`）
- `compress`: 圧縮アルゴリズム（オプション）

## 使用例

### CSVファイルの読み取り

#### ヘッダーなしのCSV
```sql
create foreign table s3_table_csv (
  name text,
  age bigint
)
  server s3_server
  options (
    uri 's3://bucket/s3_table.csv',
    format 'csv',
    has_header 'false'
  );
```

#### ヘッダーありのCSV
```sql
create foreign table s3_table_csv (
  name text,
  age bigint
)
  server s3_server
  options (
    uri 's3://bucket/s3_table_with_header.csv',
    format 'csv',
    has_header 'true'
  );
```

### JSON Linesファイルの読み取り
```sql
create foreign table s3_table_jsonl (
  name text,
  age bigint
)
  server s3_server
  options (
    uri 's3://bucket/s3_table.jsonl',
    format 'jsonl'
  );
```

### Parquetファイルの読み取り
```sql
create foreign table s3_table_parquet (
  id integer,
  bool_col boolean,
  bigint_col bigint,
  float_col real,
  date_string_col text,
  timestamp_col timestamp
)
  server s3_server
  options (
    uri 's3://bucket/s3_table.parquet',
    format 'parquet'
  );
```

### 圧縮ファイルの読み取り
```sql
create foreign table s3_table_csv_gzip (
  name text,
  age bigint
)
  server s3_server
  options (
    uri 's3://bucket/s3_table.csv.gz',
    format 'csv',
    has_header 'true',
    compress 'gzip'
  );
```

## クエリのプッシュダウン

S3 Wrapperは、以下のPostgreSQLの節をリモートS3ファイルにプッシュダウンすることで、パフォーマンスを向上させます:

- `WHERE`
- `SELECT`

## サポートされているデータ型

| Postgres型 | S3型 |
|-----------|------|
| boolean | BOOLEAN |
| char | BYTE_ARRAY |
| real | FLOAT |
| double precision | DOUBLE |
| smallint | INT32 |
| integer | INT32 |
| bigint | INT64 |
| numeric | - |
| text | BYTE_ARRAY |
| date | INT32 |
| timestamp | INT64 |

## 制限事項

このラッパーは以下の制限を使用します:

| 制限事項 | 値 |
|---------|------|
| 最大行数 | 1,048,576 |
| データサイズの上限なし | - |

## 例

いくつかのS3の使用例を示します。

### CSV

CSVファイルの例を示します。

#### 基本的な使用例

データファイル: `s3://bucket/s3_table.csv`

```csv
foo,1
bar,2
```

外部テーブルを作成してクエリを実行します:

```sql
create foreign table s3_table (
  name text,
  age bigint
)
  server s3_server
  options (
    uri 's3://bucket/s3_table.csv',
    format 'csv'
  );

select * from s3_table;
```

#### ヘッダーあり

データファイル: `s3://bucket/s3_table_with_header.csv`

```csv
name,age
foo,1
bar,2
```

外部テーブルを作成してクエリを実行します:

```sql
create foreign table s3_table (
  name text,
  age bigint
)
  server s3_server
  options (
    uri 's3://bucket/s3_table_with_header.csv',
    format 'csv',
    has_header 'true'
  );

select * from s3_table;
```

### JSON Lines

JSON Linesファイルの例を示します。

データファイル: `s3://bucket/s3_table.jsonl`

```jsonl
{"name": "foo", "age": 1}
{"name": "bar", "age": 2}
```

外部テーブルを作成してクエリを実行します:

```sql
create foreign table s3_table (
  name text,
  age bigint
)
  server s3_server
  options (
    uri 's3://bucket/s3_table.jsonl',
    format 'jsonl'
  );

select * from s3_table;
```

### Parquet

Parquetファイルの例を示します。

データファイル: `s3://bucket/s3_table.parquet`

外部テーブルを作成してクエリを実行します:

```sql
create foreign table s3_table (
  id integer,
  bool_col boolean,
  bigint_col bigint,
  float_col real,
  date_string_col text,
  timestamp_col timestamp
)
  server s3_server
  options (
    uri 's3://bucket/s3_table.parquet',
    format 'parquet'
  );

select * from s3_table;
```

### 圧縮ファイル

圧縮されたCSVファイルの例を示します。

データファイル: `s3://bucket/s3_table.csv.gz`

外部テーブルを作成してクエリを実行します:

```sql
create foreign table s3_table (
  name text,
  age bigint
)
  server s3_server
  options (
    uri 's3://bucket/s3_table.csv.gz',
    format 'csv',
    has_header 'true',
    compress 'gzip'
  );

select * from s3_table;
```

## トラブルシューティング

### ファイルが見つからない

エラー: `File not found`

S3 URIが正しいこと、およびAWS認証情報に適切な権限があることを確認してください。

### 圧縮形式のサポートエラー

エラー: `Unsupported compression algorithm`

サポートされている圧縮アルゴリズム（gzip、bzip2、xz、zlib）のいずれかを使用していることを確認してください。

### データ型の不一致

エラー: `Type mismatch`

外部テーブルで定義されたカラムのデータ型が、S3ファイルのデータと一致していることを確認してください。
