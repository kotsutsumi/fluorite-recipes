# Supabaseでの行レベルセキュリティ

## 概要

- RLSは、きめ細かなデータ認可のためのPostgres機能です
- 悪意のある行為者からデータを保護する「多層防御」を提供します
- 独自のビジネスニーズに対応する複雑なSQLルールを許可します

## 主な概念

### RLSとは？

- テーブルに接続されたPostgresルールエンジン
- テーブルにアクセスするたびに実行されます
- 本質的に、すべてのクエリに`WHERE`句を追加します

### RLSの有効化

- 公開されたスキーマのテーブルで有効にする必要があります（デフォルト: publicスキーマ）
- Supabaseダッシュボードで作成されたテーブルでは自動的に有効化されます
- SQL経由で作成されたテーブルの場合、手動で有効化:
  ```sql
  alter table <schema_name>.<table_name> enable row level security;
  ```

### ロール

Supabaseはリクエストを2つのロールにマップします:
- **`anon`**: 未認証リクエスト
- **`authenticated`**: 認証済みリクエスト

### ポリシー

ポリシーはアクセスルールを定義します。例:

```sql
create policy "Individuals can view their own todos"
on todos
for select
using (auth.uid() = user_id);
```

## 重要な考慮事項

- `auth.uid()`が未認証の場合、`null`を返します
- ポリシーで認証を明示的にチェックすることを推奨します
- Supabase認証と組み合わせてエンドツーエンドのセキュリティを実現できます

## パフォーマンスの推奨事項

- ポリシーで使用される列にインデックスを追加
- ポリシーで関数を呼び出す際は`select`を使用
- すべてのクエリにフィルタを追加
- 結合を最小限に抑える
- 可能な限りセキュリティdefiner関数を使用

このドキュメントは、PostgresとSupabaseで行レベルセキュリティを実装するための包括的なガイドを提供します。
