# クエリ最適化

## 概要

- 目的: インデックス作成を通じてデータベースクエリのパフォーマンスを向上させる
- 主な目標:
  1. インデックスで最適化できるクエリの部分を特定する
  2. 有用なインデックスを検出するためのツールを紹介する

## クエリシナリオの例

```sql
select a.name, b.date_of_purchase
from customers as a
join orders as b on a.id = b.customer_id
where a.sign_up_date > '2023-01-01' and b.status = 'shipped'
order by b.date_of_purchase
limit 10;
```

### 最適化の機会

#### WHERE句

- 頻繁にフィルタリングされる場合は`sign_up_date`にインデックスを作成
- 多様な値を持つ列の`status`にインデックスを作成

#### 結合列

- 結合列（`a.id`と`b.customer_id`）にインデックスを作成
- プライマリキー列はすでにインデックス化されています

#### ORDER BY句

- ソート効率を向上させるため、`date_of_purchase`にインデックスを作成

## インデックス作成の主要概念

### クエリプラン分析

- `explain`コマンドを使用してクエリ実行を理解する
- シーケンシャルスキャンと高コストの操作を探す
- クエリプランのコストを削減しないインデックスを削除する

### インデックスタイプ

- 適切なインデックスタイプを選択（B-tree、Hash、GIN）
- 例: BRINインデックスは、増分フィールドの場合、10倍小さくなる可能性があります

### 部分インデックス

- 特定のデータサブセット用のインデックスを作成
- 頻繁にターゲットとされるデータセグメントに便利

### 複合インデックス

- 複数の列をフィルタリングまたは結合するために使用
- 複数のインデックス参照を防ぐ

### 過剰なインデックス作成の回避

- 読み取り速度の改善と書き込みパフォーマンスのバランスを取る
- 頻繁に使用される列のみにインデックスを作成

### 統計管理

- Postgresはクエリ計画のためにテーブル統計を維持します
- 統計を最新の状態に保つため、定期的にテーブルを`analyze`する

## 結論

このガイドに従うことで、インデックスがクエリを最適化できる場所を識別し、Postgresのパフォーマンスを向上させることができます。
