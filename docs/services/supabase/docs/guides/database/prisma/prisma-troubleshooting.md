# Prismaエラーのトラブルシューティング

## 概要

- Supabaseを使用する際の一般的なPrismaエラーに対処するガイド
- エラーの完全なリストはPrismaの公式ドキュメントで利用可能

## 接続文字列パラメータの理解

- Prismaは、特別な接続文字列オプションを介して設定を構成できます
- これらの「クエリパラメータ」は、特定のエラーに対処するのに役立ちます

## 一般的なエラーと解決策

### 1. プリペアドステートメントがすでに存在する

- **原因**: トランザクションモード（ポート6543）のSupavisorはプリペアドステートメントをサポートしていません
- **解決策**: 接続文字列に`pgbouncer=true`を追加してプリペアドステートメントを無効化

### 2. データベースサーバーに到達できない

- **考えられる原因**:
  - データベースの過負荷
  - 不正な接続文字列
  - 一時的なネットワークの問題

- **解決策**:
  - レポートダッシュボードでデータベースの健全性を確認
  - 接続文字列を検証
  - 接続タイムアウトを増やす

### 3. プールからの接続取得がタイムアウト

- **考えられる原因**:
  - サーバーが圧倒されている
  - プールサイズが不十分
  - 遅いクエリ

- **解決策**:
  - プールタイムアウトを増やす
  - 接続制限を減らす
  - プールサイズを増やす
  - クエリを最適化
  - コンピュートサイズを増やす

### 4. サーバーが接続を閉じた

- **考えられる原因**:
  - 大きなクエリ戻り値
  - データベースへの大きな負荷

- **解決策**:
  - 行の戻りサイズを制限
  - データベースの負荷を最小化

### 5. スキーマドリフトが検出された

- **考えられる原因**:
  - Supabaseが管理するスキーマ更新
  - 外部スキーマ変更

- **解決策**: マイグレーションベースライニングを使用してPrismaスキーマを再同期

### 6. 最大クライアント接続数に達した

- **考えられる原因**:
  - トランザクションモード接続制限
  - セッションモードプールサイズ制限
  - 直接接続の制限

- **解決策**:
  - サーバーレスアプリにはトランザクションモードを使用
  - Prisma接続を減らす
  - プールサイズを増やす
  - 接続を適切に閉じる
  - クエリを最適化
