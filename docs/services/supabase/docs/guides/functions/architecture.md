# Edge Functions アーキテクチャ | Supabase ドキュメント

## Supabase Edge Functionsのアーキテクチャを理解する

このガイドでは、Supabase Edge Functionsのアーキテクチャと内部動作を説明します。Edge関数は、ネットワークのエッジ近くで実行されるサーバーレスのコンピュートリソースで、APIエンドポイント、ウェブフック、リアルタイムデータ処理などのタスクを低遅延で実行できます。

### 1. 例を通じたEdge Functionsの理解: 画像フィルタリング

画像共有アプリを例に、Edge関数の動作を説明します。

**ワークフローの概要**:
- ユーザーが元の画像をSupabase Storageにアップロード
- フィルターを選択すると、クライアント側のアプリが「apply-filter」という名前のEdge関数を呼び出す
- Edge関数は以下を実行:
  1. 元の画像をSupabase Storageからダウンロード
  2. ImageMagickなどのライブラリでフィルターを適用
  3. 処理した画像をStorageにアップロード
  4. クライアントにフィルター済み画像のパスを返す

**Edge Functionsの利点**:
- クライアントデバイスやデータベースに負荷をかけずに計算集中型のタスクを処理
- エッジでサーバーサイド実行により、速度とスケーラビリティを確保
- 開発者はSupabaseの関数ディレクトリ内のJavaScriptファイルで関数を定義可能

### 2. デプロイメントプロセス

Edge Functionsをデプロイすると、以下が行われます：

1. **コードのバンドル化**: Supabase CLIがTypeScript/JavaScriptコードを単一のバンドルにコンパイル
2. **グローバル配布**: バンドルがSupabaseのグローバルエッジネットワークに配布
3. **即座の利用可能性**: 数秒以内に、関数が世界中のエッジロケーションで利用可能に

### 3. リクエストのライフサイクル

Edge関数へのリクエストは以下のように処理されます：

1. **エッジゲートウェイにリクエスト到着**: ユーザーに最も近いエッジロケーションがリクエストを受信
2. **認証とルーティング**: Supabase JWTの検証、レートリミット、セキュリティチェックを実行
3. **関数の実行**: リクエストがEdge Runtimeで実行される関数にルーティング
4. **レスポンスの返却**: 関数の出力がユーザーに返される

### 4. 実行メカニズム: 高速で分離

Edge Functionsは、以下の特性を持つ分離された環境で実行されます：

- **V8 Isolates**: 各関数呼び出しは、独自のV8 Isolateで実行され、セキュリティと分離を保証
- **コールドスタート最適化**: Deno Runtimeは、コールドスタートを最小限に抑えるように最適化
- **リソース制限**: 各関数には、CPU時間、メモリ、実行時間の制限があり、公平な使用を保証

### 5. スケーラビリティと可用性

Edge Functionsは、以下により自動的にスケーリングします：

- **オンデマンドスケーリング**: トラフィックの増加に応じて、新しいインスタンスが自動的に起動
- **グローバル配布**: 複数のリージョンにまたがる冗長性により高可用性を確保
- **負荷分散**: トラフィックは利用可能なインスタンス間で自動的に分散

### 6. 監視と観測性

Supabaseは、Edge Functionsの監視ツールを提供します：

- **ログ**: すべての関数呼び出しがログに記録され、ダッシュボードで表示可能
- **メトリクス**: 実行時間、成功率、エラー率などのメトリクスを追跡
- **トレーシング**: リクエストのライフサイクル全体を追跡してパフォーマンスをデバッグ

### 7. セキュリティとアクセス制御

Edge Functionsは、複数のセキュリティレイヤーを提供します：

- **JWT検証**: Supabase JWTを使用して、認証されたリクエストのみを許可
- **Row Level Security**: Supabase APIを介してデータにアクセスする際、RLSポリシーを自動的に適用
- **環境変数**: 機密データ（APIキーなど）を安全に保存および管理

### 8. まとめ

Supabase Edge Functionsは、グローバルに分散された、スケーラブルで安全なサーバーレスコンピュートプラットフォームです。TypeScript/JavaScriptで記述され、Deno Runtimeで実行され、Supabaseエコシステムとシームレスに統合されます。

低遅延、自動スケーリング、組み込みのセキュリティにより、Edge FunctionsはモダンなWebアプリケーションを構築するための強力なツールです。
