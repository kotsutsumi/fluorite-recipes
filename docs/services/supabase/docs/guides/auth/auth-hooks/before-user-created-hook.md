# Before User Created フック

## 概要

「Before User Created」フックにより、開発者は「ユーザー作成リクエストを検査して拒否することで、望ましくないサインアップを防止」できます。これは新しいユーザーが作成される前に実行され、以下の機能を提供します:

- Supabase Authがネイティブに処理しないカスタムサインアップポリシーの実装
- 使い捨てメールドメインのブロック
- 地域やIPによるアクセス制限
- 特定のメールドメインに所属するユーザーのみに制限

## 実装方法

開発者は以下の方法でこのフックを実装できます:
1. HTTPエンドポイント
2. Postgres関数

## フックの入力

Supabase Authは2つの主要なフィールドを持つペイロードを送信します:

| フィールド | 型 | 説明 |
|-----------|----------|----------------------------------------------------------------|
| `metadata`| `object` | リクエストメタデータ（IPアドレス、リクエストID、フックタイプ） |
| `user` | `object` | 作成されようとしているユーザーレコード（`auth.users`テーブルと一致） |

### 重要な注意事項
「フックはデータベースへの挿入の直前に実行されるため、フックが呼び出された時点では、このユーザーはPostgresで見つかりません。」

## フックの出力

フックは以下のことができます:
- サインアップを許可する（空のオブジェクトまたは204ステータスを返す）
- サインアップを拒否する（オプションのHTTPステータスコードを含むエラーオブジェクトを返す）

### エラーレスポンスの例
```json
{
  "error": {
    "http_code": 400,
    "message": "会社のメールアドレスからのサインアップのみ許可されています。"
  }
}
```

## 使用例

ドキュメントでは以下の詳細な例が提供されています:
- 特定のメールドメインからのサインアップを許可
- 特定のOAuthプロバイダーからのサインアップをブロック
- IPアドレスやCIDR範囲によるサインアップの制限

各使用例について、HTTP（Edge Function）とSQL（Postgres関数）の両方の実装が示されています。

このフックは、「どのユーザーが登録を許可されるかを完全に制御」し、柔軟なサーバーサイドロジックを提供します。
