# Turso - 耐久性保証

Tursoのデータ耐久性とコミットレイテンシーについて説明します。

## 耐久性保証

### プラン別の耐久性

| プラン | 耐久性 | コミットレイテンシー |
|--------|--------|---------------------|
| Free | 99.999999999% | 100ms |
| Developer | 99.999999999% | 50ms |
| Scaler | 99.999999999% | 25ms |
| Pro | 99.999999999% | 10ms |

すべてのプランで**99.999999999%（イレブンナイン）**の耐久性を保証しています。

## アーキテクチャの詳細

### ディスクレスアーキテクチャ

Tursoは、AWSリージョンでディスクレスアーキテクチャを採用しています：

- **S3-Express One Zone**でデータをバックアップ
- **S3**による追加バックアップ
- コミットは安全に保存された後にのみ確認応答
- コンピュートノードは変更可能
- ローカルディスクはキャッシュとして機能

### ストレージコンポーネント

SQLite互換のストレージを使用：

1. **Write-Ahead Log (WAL)**
   - トランザクションログ
   - リカバリに使用

2. **メインデータベースファイル**
   - 永続的なデータストレージ
   - WALから定期的にデータをフォールド

### 定期的なデータフォールディング

WALとメインファイル間でデータを定期的にフォールドします：

- パフォーマンスの最適化
- ストレージ効率の向上
- リカバリ時間の短縮

## コミットレイテンシーの仕組み

### バッチ処理

- 複数のデータベース間でコミットをバッチ処理
- 時間ベースのバッチング
- 効率的なストレージ利用

### コミットウィンドウ

プラン別のコミットウィンドウ：

- **Free**: 100ms
- **Developer**: 50ms
- **Scaler**: 25ms
- **Pro**: 10ms

### シーケンス図

```
Client -> Database: BEGIN TRANSACTION
Client -> Database: INSERT/UPDATE/DELETE
Client -> Database: COMMIT

Database: [コミットウィンドウ待機]
Database -> S3-Express: データ書き込み
S3-Express -> Database: 確認応答
Database -> Client: COMMIT成功
```

## テスト手法

### Deterministic Simulation Testing (DST)

Tursoは厳密なテストを実施しています：

- **Antithesis**を使用
- フルシステムDeterministic Simulation Hypervisor
- 複雑なシナリオを効率的にテスト

### テストの利点

- 予測可能な結果
- 再現可能なテスト
- エッジケースの発見
- 高い信頼性

## Pro & Enterpriseの追加機能

### 独自インフラストラクチャ

> "Pro and Enterprise customers can use their own S3 / S3-express buckets, guaranteeing that data lives inside their infrastructure."

- 独自のS3バケット使用可能
- 独自のS3-Expressバケット使用可能
- データが自社インフラ内に保持
- コンプライアンス要件への対応

## マルチテナントアーキテクチャ

### 特徴

- 効率的なリソース共有
- コスト最適化
- 分離されたセキュリティ
- スケーラビリティ

### 効率的なコミットバッチング

- 複数のデータベースで共有
- ストレージIOの最適化
- レイテンシーの予測可能性

## パフォーマンスの最適化

### 書き込みパフォーマンス

1. **バッチ処理**: 複数のコミットをまとめて処理
2. **非同期処理**: クライアントのブロック時間を最小化
3. **並列処理**: 複数のストレージ層への同時書き込み

### 読み取りパフォーマンス

1. **キャッシング**: ローカルディスクキャッシュ
2. **レプリケーション**: 読み取り専用レプリカ
3. **エッジ配置**: ユーザーに近いロケーション

## データ損失シナリオ

### 保護されているケース

- コンピュートノードの障害
- ディスク障害
- リージョン内の一時的な問題
- ネットワーク障害

### リカバリメカニズム

1. WALからのリカバリ
2. S3-Expressからの復元
3. S3バックアップからの復元
4. ポイントインタイムリカバリ

## ベストプラクティス

### アプリケーション設計

1. **適切なトランザクション管理**: 長時間のトランザクションを避ける
2. **エラーハンドリング**: コミット失敗時のリトライ実装
3. **バッチ操作**: 複数の操作をトランザクション内でまとめる

### モニタリング

1. **コミットレイテンシー**: アプリケーションメトリクスで監視
2. **エラー率**: コミット失敗率を追跡
3. **パフォーマンス**: クエリ実行時間を測定

## SLA（Service Level Agreement）

### 可用性

- 99.9%以上の稼働時間
- プランによって異なるSLA
- ダウンタイムの補償

### サポート

- Proプラン: 優先サポート
- Enterpriseプラン: 専任サポート
- コミュニティサポート: Discord

## 関連リンク

- [Turso公式サイト](https://turso.tech/)
- [Turso Documentation](https://docs.turso.tech/)
- [AWS S3-Express](https://aws.amazon.com/s3/storage-classes/express-one-zone/)
- [SQLite WAL Mode](https://www.sqlite.org/wal.html)
- [Antithesis Testing](https://antithesis.com/)
