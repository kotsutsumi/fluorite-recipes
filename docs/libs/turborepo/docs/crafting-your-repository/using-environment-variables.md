# 環境変数の使用

環境変数入力は、Turborepo設定で考慮する必要があるアプリケーションの重要な部分です。

Turborepoで環境変数を扱う際には、3つの重要な質問があります：

- [環境変数はタスクハッシュで考慮されているか？](#adding-environment-variables-to-task-hashes)
- [`turbo`はどの環境モードを使用するか？](#environment-modes)
- [`.env`ファイルを処理したか？](#handling-env-files)

> **エラー**: 設定で環境変数を考慮しないと、間違った設定でアプリケーションをシップする結果になる可能性があります。これにより、プレビューデプロイを本番環境にシップするような深刻な問題が発生する可能性があります。

> **知っておくと良いこと**: Turborepoは、独自の動作を設定するために[システム環境変数](/docs/reference/system-environment-variables)も使用します。以下では、タスクのランタイム用の環境変数と、それらがタスクハッシュにどのように影響するかについての情報を見つけることができます。

## タスクハッシュへの環境変数の追加

Turborepoは、アプリケーションの動作の変更を考慮するために、環境変数を認識する必要があります。これを行うには、`turbo.json`ファイルの`env`および`globalEnv`キーを使用します。

```json title="./turbo.json"
{
  "globalEnv": ["IMPORTANT_GLOBAL_VARIABLE"],
  "tasks": {
    "build": {
      "env": ["MY_API_URL", "MY_API_KEY"]
    }
  }
}
```

- **globalEnv**: このリストの環境変数の値の変更は、すべてのタスクのハッシュを変更します。
- **env**: タスクに影響を与える環境変数の値の変更を含め、より細かい粒度を可能にします。例えば、`lint`タスクは`API_KEY`の値が変更されたときにキャッシュミスする必要はおそらくありませんが、`build`タスクはおそらくすべきです。

## 環境モード

Turborepoは、2つの環境モードで動作できます：

### Strictモード（デフォルト）

- `turbo.json`で指定された環境変数のみにフィルタリングします
- 意図しないキャッシュヒットを防ぐのに役立ちます
- 高度なシナリオには`passThroughEnv`を使用できます

### Looseモード

- すべての環境変数を許可します
- 移行が簡単ですが、設定の問題を見落とすリスクがあります

## `.env`ファイルの処理

`.env`ファイルは特定のパッケージに配置します。

## ベストプラクティス

- `eslint-config-turbo`を使用して環境変数の使用を検証します
- ランタイム中に環境変数を作成/変更しないようにします

## フレームワーク推論

一般的なフレームワークのプレフィックスワイルドカードを自動的に追加します。`--framework-inference=false`で無効にできます。

## Next.jsの例

```json
{
  "tasks": {
    "build": {
      "env": ["MY_API_URL", "MY_API_KEY"],
      "inputs": [
        "$TURBO_DEFAULT$",
        ".env.production.local",
        ".env.local",
        ".env.production",
        ".env"
      ]
    }
  }
}
```

## トラブルシューティング

`--summarize`フラグを使用してタスク設定の詳細を生成します。

## 重要な考慮事項

環境変数の慎重な管理により、異なる環境間で一貫性があり予測可能なビルド動作が保証されます。
