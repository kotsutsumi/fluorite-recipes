# メンタルモデル

## データベースマイグレーションとは

データベースマイグレーションは、データベーススキーマ構造を変更および進化させる制御された変更です。以下のような遷移を支援します：

- テーブルとカラムの作成または削除
- テーブル内のフィールドの分割
- 型と制約の追加

### データベーススキーマを進化させるパターン

主な2つのスキーママイグレーションパターン：

1. **モデル/エンティティファーストマイグレーション**：
   - コード内でデータベーススキーマ構造を定義
   - マイグレーションツールを使用して、アプリケーションとデータベーススキーマを同期する SQL を生成

2. **データベースファーストマイグレーション**：
   - SQL を使用してデータベース構造を定義
   - データベースをイントロスペクトして、スキーマ構造を記述するコードを生成

マイグレーションファイルは：
- アプリケーションコードと一緒に保存すべき
- バージョン管理で追跡すべき
- チームメンバーと共有すべき

マイグレーションは状態管理を提供し、時間の経過とともにデータベース状態を追跡するのに役立ちます。

## Prisma Migrate とは

Prisma Migrate は、モデル/エンティティファーストマイグレーションパターンをサポートするデータベースマイグレーションツールです。ワークフローは以下の通りです：

**ローカル開発**：
1. Prisma スキーマを進化させる
2. `prisma migrate dev` または `prisma db push` を使用してローカルデータベースとスキーマを同期

**プレビュー/ステージング**：
1. 変更をフィーチャープルリクエストにプッシュ
2. CI システムを使用して `prisma migrate deploy` でスキーマを同期

**本番環境**：
1. アプリケーションコードをメインブランチにマージ
2. CI システムを使用して `prisma migrate deploy` でスキーマを同期

## Prisma Migrate がマイグレーション状態を追跡する方法

Prisma Migrate は以下を使用します：

- Prisma スキーマ（真実の情報源）
- マイグレーション履歴
- マイグレーションテーブル
- データベーススキーマ

## 要件

- 環境ごとに個別のデータベースを使用
- 使い捨ての開発データベース
- 一貫したデータベース設定
- 真実の情報源としての Prisma スキーマ

## データベーススキーマの進化

### 開発環境

#### `prisma migrate dev` でマイグレーション履歴を追跡

- SQL マイグレーションファイルを自動生成
- マイグレーションをデータベースに適用
- マイグレーションテーブルを更新
- スキーマドリフトを検出するためにシャドウデータベースを使用

#### スキーマドリフトの解決

`prisma migrate diff` を使用して：
- マイグレーション履歴を比較
- データベーススキーマを元に戻す

詳細については、[公式ドキュメント](https://www.prisma.io/docs/orm/prisma-migrate/understanding-prisma-migrate/mental-model)を参照してください。
