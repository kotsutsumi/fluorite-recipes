# 依存関係のキャッシュ

依存関係をキャッシュしてビルドを高速化する方法を学びます。

* * *

ビルドジョブがプロジェクトのコンパイルを開始する前に、すべてのプロジェクト依存関係がディスク上で利用可能である必要があります。依存関係の取得に時間がかかるほど、ビルドの完了を待つ時間が長くなります。そのため、依存関係のキャッシュはビルドの高速化の重要な部分です。

> キャッシュやビルドプロセスの他の側面を改善して、ビルドを確実に高速にするために積極的に取り組んでいます。

## カスタムキャッシュ

[eas.json](/build/eas-json)のビルドプロファイルの`cache`フィールドを使用して、特定のファイルとディレクトリのキャッシュを設定できます。指定されたファイルは、ビルドが成功した後に永続ストレージに保存され、JavaScript依存関係がインストールされた後の後続のビルドで復元されます。復元は既存のファイルを上書きしません。`cache.key`の値を変更すると、キャッシュが無効になります。`cache`オブジェクトの他のプロパティを変更しても、キャッシュが無効になります。

### カスタムキャッシュの設定例

```json
{
  "build": {
    "production": {
      "cache": {
        "key": "my-cache-v1",
        "paths": [
          "node_modules",
          ".expo"
        ]
      }
    }
  }
}
```

## JavaScript依存関係

EAS Buildは、ビルドジョブのJavaScript依存関係のダウンロードを高速化できるnpmキャッシュサーバーを実行しています。デフォルトでは、npmまたはYarn 2+を使用するプロジェクトはキャッシュを使用します。ただし、Yarn 1（Classic）では、プロジェクトのpackage.jsonでこの[回避策](/build-reference/npm-cache-with-yarn)を適用してキャッシュを使用する必要があります。

ビルドでnpmキャッシュサーバーの使用を無効にするには、eas.jsonで`EAS_BUILD_DISABLE_NPM_CACHE`環境変数の値を`"1"`に設定します。

```json
{
  "build": {
    "production": {
      "env": {
        "EAS_BUILD_DISABLE_NPM_CACHE": "1"
        ...
      }
      ...
    }
    ...
  }
  ...
}
```

### イミュータブルロックファイル

デフォルトでは、Nodeパッケージは、お好みのパッケージマネージャーのイミュータブルロックファイルフラグ/コマンド（例：`yarn --frozen-lockfile`または`npm ci`）でインストールされます。これを無効にしたい場合は、eas.jsonで`EAS_NO_FROZEN_LOCKFILE`環境変数を`"1"`に設定できます。

```json
{
  "build": {
    "production": {
      "env": {
        "EAS_NO_FROZEN_LOCKFILE": "1"
      }
    }
  }
}
```

## ネイティブ依存関係のキャッシュ

### Android

Androidビルドでは、Gradle依存関係が自動的にキャッシュされます。キャッシュは次のビルドで再利用され、依存関係のダウンロード時間を大幅に短縮します。

### iOS

iOSビルドでは、CocoaPods依存関係がキャッシュサーバーからキャッシュされます。これにより、pod installの実行時間が短縮されます。

## キャッシュのベストプラクティス

1. **適切なキャッシュキー**: プロジェクトの依存関係が変更されたときにキャッシュを無効にする
2. **選択的なキャッシュ**: 必要なディレクトリのみをキャッシュ
3. **キャッシュサイズの管理**: 大きすぎるキャッシュは復元に時間がかかる
4. **定期的なキャッシュのクリア**: 古いキャッシュを定期的にクリア

## キャッシュのパフォーマンス測定

ビルドログでキャッシュの効果を確認できます：

```
Restoring cache...
✓ Restored 450 MB in 12 seconds
Installing dependencies...
✓ Dependencies installed in 28 seconds (was 3 minutes without cache)
```

## トラブルシューティング

キャッシュに問題がある場合：

1. キャッシュキーを変更してキャッシュを無効化
2. キャッシュされているパスが正しいことを確認
3. ビルドログでキャッシュの復元と保存を確認
4. 必要に応じて、キャッシュを完全に無効にしてテスト

適切なキャッシュ戦略により、ビルド時間を50%以上短縮できます。
