# Android向けプリビルドExpoモジュール

## メリット

### 1. ローカル開発の高速化

Androidビルド時間が最大25%短縮されます。

### 2. 開発者エクスペリエンスの向上

開発中の待ち時間が減少します。

### 3. 自動最適化

SDK 53以降の新しいプロジェクトでは、箱から出してすぐに動作します。

## プリビルドExpoモジュールの仕組み

Androidビルドプロセス中、`[📦]`絵文字プレフィックスが付いたパッケージはプリビルドバージョンを示します。

### ビルド出力の例

`npx expo run:android`を実行すると、プリコンパイルされたパッケージが`[📦]`マークで表示されます：

```
[📦] expo-constants
[📦] expo-file-system
[📦] expo-font
[📦] expo-image
[📦] expo-router
```

このマークが付いているパッケージは、ソースからコンパイルされるのではなく、プリビルドされたバイナリが使用されています。

## 設定

### SDK 53以降

Expoテンプレートで作成されたプロジェクトでは、設定は不要です。プリビルドモジュールがデフォルトで有効になっています。

### プリビルドExpoモジュールからオプトアウト

#### 完全にオプトアウト

`package.json`に追加します：

```json
{
  "expo": {
    "autolinking": {
      "android": {
        "buildFromSource": [".*"]
      }
    }
  }
}
```

これにより、すべてのExpoモジュールがソースからビルドされます。

#### 選択的にオプトアウト

特定のモジュールのみをソースからビルドする場合：

```json
{
  "expo": {
    "autolinking": {
      "android": {
        "buildFromSource": [
          "expo-camera",
          "expo-web-browser",
          "expo-linking"
        ]
      }
    }
  }
}
```

この設定では、リストされたモジュールのみがソースからビルドされ、その他のモジュールはプリビルドバージョンが使用されます。

## 考慮事項

### 既存プロジェクトのアップグレード

SDK 53以降にアップグレードする既存プロジェクトでも動作します。

### パフォーマンスの改善

パフォーマンスの改善は、ハードウェアによって異なります：

- **高性能マシン**: 15-25%の短縮
- **標準マシン**: 10-15%の短縮
- **低性能マシン**: 5-10%の短縮

### EASビルド

EAS Buildsでは、控えめな改善が見られます。クラウドビルド環境はすでに最適化されているため、ローカル開発ほどの改善は見られません。

## デバッグとトラブルシューティング

### プリビルドモジュールの確認

ビルドログで`[📦]`マークを確認します。

### ソースからのビルドが必要な場合

以下の場合は、ソースからのビルドが必要です：

1. **カスタム変更**: モジュールにカスタム変更を加えた場合
2. **デバッグ**: モジュールのソースコードをデバッグする必要がある場合
3. **互換性**: 特定のバージョンやパッチが必要な場合

### キャッシュのクリア

プリビルドモジュールのキャッシュをクリアする場合：

```bash
cd android
./gradlew clean
cd ..
npx expo run:android --no-build-cache
```

## ベストプラクティス

### 1. デフォルト設定を使用

特別な理由がない限り、デフォルト設定（プリビルド有効）を使用してください。

### 2. 選択的オプトアウト

すべてのモジュールからオプトアウトするのではなく、必要なモジュールのみを選択してください。

### 3. パフォーマンスの測定

ビルド時間を測定して、プリビルドモジュールの効果を確認してください。

```bash
# ビルド時間を測定
time npx expo run:android
```

## まとめ

プリビルドExpoモジュールは、Android開発を大幅に高速化する機能です。SDK 53以降の新しいプロジェクトでは自動的に有効になり、既存プロジェクトもアップグレードするだけで恩恵を受けられます。
