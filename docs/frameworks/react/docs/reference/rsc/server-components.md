# サーバコンポーネント

サーバコンポーネントは、クライアントアプリケーションや SSR サーバとは別の環境で、バンドル前に事前にレンダーされる新しいタイプのコンポーネントです。

## 概要

この別環境が、React Server Components における「サーバ」です。サーバコンポーネントは、CI サーバでビルド時に一度だけ実行することも、ウェブサーバを使用してリクエストごとに実行することもできます。

### サーバを使用しないサーバコンポーネント

サーバコンポーネントは、ビルド時に実行して静的サイトジェネレーション (SSG) を行うことができます。この場合：

- ビルド時に実行可能
- ファイルシステムから読み取り可能
- 静的コンテンツのフェッチが可能
- ウェブサーバは必須ではない

従来のクライアントサイドレンダリングと比較して、サーバコンポーネントは：

- 追加のライブラリをバンドルに含めない
- 最初のページロード時にすぐコンテンツを表示
- 静的コンテンツのレンダリングを効率化

### サーバを使用するサーバコンポーネント

サーバコンポーネントは、ページのリクエスト時にウェブサーバ内で実行することもできます。これにより：

- ページのリクエスト時にウェブサーバ内で実行
- API を構築せずにデータレイヤにアクセス
- アプリケーションがバンドルされる前にレンダー
- データと JSX をクライアントコンポーネントに props として渡す

React にとって「サーバコンポーネント」が意味するのは、サーバコンポーネントが CI サーバの一部として実行されるか、ウェブサーバとして実行されるかは関係ありません。

一方で、[クライアントコンポーネント](/reference/rsc/use-client)は、クライアント（ブラウザ）側で実行されるコンポーネントです。SSR を使用している場合、クライアントコンポーネントも HTML としてサーバでレンダーされることがあります。React にとって「クライアントコンポーネント」が意味するのは、そのコードはバンドルに含まれ、サーバ専用の機能（ファイルシステムへのアクセスなど）を使用できない、ということです。

## サーバコンポーネントにインタラクティビティを追加する

サーバコンポーネントはブラウザに送信されないため、`useState` などのインタラクティブな API を使用できません。サーバコンポーネントにインタラクティビティを追加するには、`"use client"` ディレクティブを使用してクライアントコンポーネントと組み合わせます。

### 注意事項

サーバコンポーネントには `"use server"` ディレクティブはありません。`"use server"` ディレクティブは、[サーバ関数](/reference/rsc/server-functions)をマークするために使用されます。

## サーバコンポーネントはどこで使用されるのか？

デフォルトでは、Next.js およびその他の React Server Components 対応フレームワークでは、すべてのコンポーネントがサーバコンポーネントです。これにより、サーバコンポーネントがデフォルトで使用され、追加の設定なしでパフォーマンスの最適化が得られます。

必要に応じて、[`"use client"`](/reference/rsc/use-client) ディレクティブを使用してクライアントコンポーネントを選択できます。

## サーバコンポーネントはサーバでどのように実行されるのか？

サーバコンポーネントは、フレームワークがサーバ上で実行することで動作します。フレームワークは以下のことを処理します：

1. サーバコンポーネントのレンダリング
2. クライアントコンポーネントのバンドル作成
3. サーバコンポーネントのデータとクライアントコンポーネントの統合

開発者はこのプロセスを意識する必要はありませんが、どのコンポーネントがサーバで実行され、どのコンポーネントがクライアントで実行されるかを理解することは重要です。

## サーバコンポーネント内でクライアント専用コードを使用する方法

サーバコンポーネントはサーバで実行されるため、ブラウザ API にはアクセスできません。

ブラウザ API を使用する必要がある場合は、クライアントコンポーネント（`"use client"` でマークされたコンポーネント）内でそのコードを移動する必要があります。

```javascript
'use client';

import { useState, useEffect } from 'react';

export default function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    // ブラウザ API を使用可能
    console.log('Counter mounted');
  }, []);

  return (
    <div>
      <p>Count: {count}</p>
      <button onClick={() => setCount(count + 1)}>
        Increment
      </button>
    </div>
  );
}
```

## サーバコンポーネントをサードパーティパッケージで使用する

サーバコンポーネントは新しい機能であるため、エコシステム内のサードパーティパッケージは、クライアント専用機能（`useState`、`useEffect` など）を使用するコンポーネントに `"use client"` ディレクティブを追加し始めたばかりです。

今日では、クライアント専用機能を使用する多くの npm パッケージのコンポーネントには、まだ `"use client"` ディレクティブがありません。これらのサードパーティコンポーネントは、`"use client"` ディレクティブを持つ独自のクライアントコンポーネント内では期待通りに動作しますが、サーバコンポーネント内では動作しません。

### 解決策

サードパーティパッケージのコンポーネントをサーバコンポーネント内で使用する必要がある場合は、そのコンポーネントを独自のクライアントコンポーネントでラップできます：

```javascript
'use client';

import { ThirdPartyComponent } from 'third-party-library';

export default function ClientWrapper(props) {
  return <ThirdPartyComponent {...props} />;
}
```

これで、サーバコンポーネント内で `ClientWrapper` を直接インポートして使用できます。

## サーバコンポーネントのベストプラクティス

### データフェッチをサーバコンポーネントで行う

可能な限り、データフェッチはサーバコンポーネントで行います。これにより：

- クライアントに送信されるコード量が削減されます
- データフェッチのロジックがサーバ側に保たれます
- データベースクエリがサーバで実行されるため、レイテンシが削減されます

```javascript
// サーバコンポーネント
async function BlogPost({ id }) {
  const post = await db.posts.findById(id);

  return (
    <article>
      <h1>{post.title}</h1>
      <p>{post.content}</p>
    </article>
  );
}
```

### クライアントコンポーネントを可能な限り下層に配置する

コンポーネントツリーの中で、クライアントコンポーネントを可能な限り下層に配置します。これにより、サーバコンポーネントの利点を最大化できます。

```javascript
// 推奨される方法
function Page() {
  return (
    <div>
      <Header />
      <ServerContent />
      <InteractiveButton /> {/* クライアントコンポーネント */}
    </div>
  );
}

// 避けるべき方法
'use client';

function Page() {
  // ページ全体がクライアントコンポーネントになる
  return (
    <div>
      <Header />
      <ServerContent />
      <InteractiveButton />
    </div>
  );
}
```

### サーバコンポーネントとクライアントコンポーネント間でデータを渡す

サーバコンポーネントからクライアントコンポーネントに props としてデータを渡す場合、そのデータはシリアライズ可能である必要があります。

シリアライズ可能なデータ：
- プリミティブ型（文字列、数値、boolean など）
- 配列とオブジェクト
- Date オブジェクト
- JSON でシリアライズ可能なデータ

シリアライズ不可能なデータ：
- 関数
- クラスインスタンス
- シンボル

```javascript
// サーバコンポーネント
async function Page() {
  const data = await fetchData();

  return (
    <ClientComponent
      // OK: プリミティブとシリアライズ可能なオブジェクト
      data={data}
      // NG: 関数は渡せない
      // onClick={() => console.log('clicked')}
    />
  );
}
```

## まとめ

サーバコンポーネントは、React アプリケーションのパフォーマンスを向上させる強力な機能です。適切に使用することで：

- クライアントに送信される JavaScript の量を削減
- 初期ページロードの高速化
- サーバサイドのリソースへの直接アクセス

クライアントコンポーネントと組み合わせることで、高性能でインタラクティブなアプリケーションを構築できます。
