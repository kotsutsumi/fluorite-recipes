# Next.jsにおけるセキュリティの考え方

**公開日**: 2023年10月23日(月曜日)

**著者**: Sebastian Markbåge (@sebmarkbage)

## データ処理モデルの選択

この記事では、Next.jsにおけるデータ処理の3つの主要なアプローチについて説明します:

- **HTTP APIs**(既存の大規模プロジェクトに推奨)
- **データアクセスレイヤー**(新規プロジェクトに推奨)
- **コンポーネントレベルのデータアクセス**(プロトタイピングに推奨)

著者は、開発者とセキュリティ監査者の明確性を維持するために、「1つのアプローチに固執し、あまり混在させない」ことを推奨しています。

## データ処理アプローチ

### HTTP APIs

- Server Componentsを「デフォルトで安全でない/信頼できない」として扱う
- ゼロトラストネットワークの原則を使用
- `fetch()`を使用してAPIエンドポイントを呼び出す
- 既存のバックエンドチームがセキュリティプラクティスを適用できる

### データアクセスレイヤー

- データアクセス用の内部JavaScriptライブラリを作成
- データアクセスチェックを統合
- すべてのAPIがユーザー認証をチェックすることを保証
- 原則: 「Server Component関数本体は、リクエストを発行している現在のユーザーがアクセスを許可されているデータのみを参照する必要があります」

### コンポーネントレベルのデータアクセス

- Server Componentsに直接データベースクエリを配置
- 迅速なプロトタイピングのみに推奨
- 「use client」ファイルの慎重な監査が必要

## セキュリティの推奨事項

- `server-only`を使用して、機密コードがクライアントに漏洩しないようにする
- 入力パラメータを検証する
- データを読み取るたびにアクセス制御を再検証する
- レンダリング中の副作用を避ける
- 変更にはServer Actionsを使用する

## 追加のセキュリティ機能

- データ露出を防ぐための実験的なReact Taint API
- Server Actionsでクローズオーバーされた変数の暗号化
- Server ActionsでのCSRF保護
- Originヘッダーの検証

この記事は、安全なデータ処理プラクティスを示すコード例を提供し、サーバーコンポーネントとクライアントコンポーネント間のデータフローを慎重に管理することの重要性を強調しています。
