# Next.js 8 Webpackメモリ改善

**投稿日**: 2019年2月19日（火曜日）

**著者**: Connor Davis、Tim Neutkens

最近、[Next.js 8](/blog/next-8)が導入されました。このリリースには、ビルド時のメモリ使用量の大幅な削減が含まれていました。このブログ記事では、コミュニティのためにwebpackを最適化するのに役立った方法を探ります。

## Next.jsとWebpack

Next.jsはゼロ設定で、[webpack](https://webpack.js.org/)や[Babel](https://babeljs.io)などのツールの上に構築されています。その目標は、重要なこと、つまりアプリケーションコードに集中できるようにすることです。

モダンなWebアプリケーションは、1つ以上のページで構成されています。たとえば、ホームページ、ブログ、ダッシュボード、製品リストなどです。

Next.jsでは、これらのページはプロジェクトのルートにある特別な`pages`ディレクトリ内のファイルになります。

たとえば、`pages/about.js`ファイルはURL`/about`にマッピングされます。

## メモリ使用量の問題

フレームワークの主要な設計制約の1つは、単一ページと数千ページの両方でうまく機能する必要があることです。

[サーバーレスNext.js](/blog/next-8#serverless-nextjs)を実装する際、数百のページを持つプロジェクトで`next build`を実行すると、高いメモリ使用量が発生することがすぐに明らかになりました。時にはNode.jsが持つ約1.4 GBのメモリヒープ制限を超えることもありました。

## 最適化

チームは、Chromeデベロッパーツールを使用してビルドプロセスのメモリ使用量をプロファイリングし始め、いくつかの重要な最適化を発見しました：

### 1. 同時実行制限

webpackがすべてのファイルを同時に書き込もうとしていることがわかり、これが大量のメモリ割り当てを引き起こしていました。`asyncLib.forEachLimit()`を使用して同時実行制限を実装することで、メモリチャンクを548 MBから34 MBに削減しました。

### 2. キャッシュされたソースの最適化

`CachedSource`が不必要にメモリをキャッシュしていることに気付きました。Tobias Koppersと協力した後、`output.futureEmitAssets`を実装し、メモリ割り当てをわずか182 KBにさらに削減しました。

## 重要な引用

- 「割り当てられたメモリの量は、ページの量と直接相関していました。つまり、ページが多いほど、メモリ使用量が多くなります。」
- 「Next.jsとwebpackのメモリ使用量とパフォーマンスを積極的に改善し続けます。」

## まとめ

これらの最適化はNext.js 8に組み込まれ、コミュニティ全体に利益をもたらしています。
