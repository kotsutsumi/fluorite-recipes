# Fast Refresh

Fast Refreshは、Reactコンポーネントへの編集に対してインスタントフィードバックを提供するNext.jsの機能です。Fast RefreshはNext.js **9.4以降**のすべてのNext.jsアプリケーションでデフォルトで有効になっています。Next.js Fast Refreshを有効にすると、ほとんどの編集は1秒以内に表示され、**状態が失われることはありません**。

## 仕組み

- **Reactコンポーネントのみをエクスポートする**ファイルを編集する場合、Fast Refreshはそのファイルのコードのみを更新し、コンポーネントを再レンダリングします。スタイル、レンダリングロジック、イベントハンドラー、エフェクトなど、そのファイル内のすべてを編集できます。
- Reactコンポーネント_ではない_エクスポートを含むファイルを編集する場合、Fast Refreshはそのファイルと、それをインポートする他のファイルの両方を再実行します。したがって、`Button.js`と`Modal.js`の両方が`theme.js`をインポートしている場合、`theme.js`を編集すると両方のコンポーネントが更新されます。
- 最後に、Reactツリーの_外側_のファイルによって**インポートされる**ファイルを編集する場合、Fast Refreshは**完全なリロードを実行するようにフォールバック**します。Reactコンポーネントをレンダリングするファイルがあるが、Reactコンポーネントでは_ない_値もエクスポートしている場合があります。たとえば、コンポーネントが定数もエクスポートし、Reactではないユーティリティファイルがそれをインポートしている場合です。その場合は、定数を別のファイルに移行し、両方のファイルにインポートすることを検討してください。これにより、Fast Refreshが再び機能します。他のケースも通常、同様の方法で解決できます。

## エラー耐性

### 構文エラー

開発中に構文エラーを犯した場合、それを修正して再度ファイルを保存できます。エラーは自動的に消え、アプリをリロードする必要はありません。**コンポーネントの状態は失われません**。

### ランタイムエラー

コンポーネント内でランタイムエラーになる間違いを犯した場合、コンテキスト付きのオーバーレイが表示されます。エラーを修正すると、アプリをリロードせずにオーバーレイが自動的に閉じます。

レンダリング中にエラーが発生しなかった場合、コンポーネントの状態は保持されます。エラーがレンダリング中に発生した場合、Reactは更新されたコードを使用してアプリケーションを再マウントします。

アプリに[エラー境界](https://react.dev/reference/react/Component#catching-rendering-errors-with-an-error-boundary)がある場合（本番環境での適切な失敗のために良いアイデアです）、レンダリングエラーの後の次の編集でレンダリングを再試行します。これは、エラー境界が常にルートアプリ状態へのリセットを強制しないことを意味します。ただし、エラー境界が_あまりにも_細かくなりすぎないことに注意してください。これらはReactによって本番環境で使用され、常に意図的に設計する必要があります。

## 制限事項

Fast Refreshは、編集しているコンポーネントでローカルなReact状態を保持しようとしますが、そうすることが安全な場合のみです。ファイルを編集するたびに状態がリセットされる理由のいくつかは次のとおりです:

- クラスコンポーネントのローカル状態は保持されません（関数コンポーネントとフックのみが状態を保持します）。
- 編集しているファイルには、Reactコンポーネントに加えて_その他_のエクスポートがある場合があります。
- 時には、ファイルは`HOC(WrappedComponent)`のような高階コンポーネントの呼び出しの結果をエクスポートすることがあります。返されるコンポーネントがクラスの場合、その状態はリセットされます。
- `export default () => <div />;`のような無名のアロー関数は、Fast Refreshがローカル状態を保持しないようにします。大規模なコードベースの場合は、[`name-default-component`コードモッド](/docs/app/building-your-application/upgrading/codemods#name-default-component)を使用できます。

コードベースがより関数コンポーネントとフックに移行するにつれて、より多くのケースで状態が保持されることを期待できます。

## ヒント

- Fast Refreshは、デフォルトで関数コンポーネント（およびフック）でReactローカル状態を保持します。
- 状態をリセットし、コンポーネントを強制的に再マウントしたい場合があります。たとえば、マウント時にのみ発生するアニメーションを微調整する場合に便利です。これを行うには、編集しているファイルのどこかに`// @refresh reset`を追加できます。このディレクティブはファイルに対してローカルであり、編集するたびにFast Refreshにそのファイルで定義されたコンポーネントを再マウントするように指示します。
- 開発中に編集しているコンポーネントに`console.log`またはデバッガーステートメントを配置できます。
- インポートがESModulesであり、CommonJSではないことに注意してください。

## Fast RefreshとHooks

可能な場合、Fast Refreshは編集間でコンポーネントの状態を保持しようとします。特に、`useState`と`useRef`は、引数やHook呼び出しの順序を変更しない限り、以前の値を保持します。

依存関係を持つフック（`useEffect`、`useMemo`、`useCallback`など）は、Fast Refresh中に_常に_更新されます。Fast Refreshが発生している間、それらの依存関係リストは無視されます。

たとえば、`useMemo(() => x * 2, [x])`を`useMemo(() => x * 10, [x])`に編集すると、`x`（依存関係）が変更されていなくても再実行されます。Reactがそうしなかった場合、編集内容は画面に反映されません！

時にはこれが予期しない結果につながることがあります。たとえば、依存関係配列が空の`useEffect`でも、Fast Refresh中に1回再実行されます。

ただし、`useEffect`が時折再実行されることに対して耐性のあるコードを書くことは、Fast Refreshがなくても良い習慣です。後で新しい依存関係を導入しやすくなり、[React Strict Mode](/docs/app/api-reference/config/next-config-js/reactStrictMode)によって強制されます。これを有効にすることを強くお勧めします。
