# ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

Next.js ã§è¤‡æ•°ã®ãƒ†ãƒŠãƒ³ãƒˆï¼ˆé¡§å®¢ï¼‰ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã™ã‚‹ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## æ¦‚è¦

ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€å˜ä¸€ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§è¤‡æ•°ã®é¡§å®¢ï¼ˆãƒ†ãƒŠãƒ³ãƒˆï¼‰ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã™ã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã™ã€‚å„ãƒ†ãƒŠãƒ³ãƒˆã¯ç‹¬è‡ªã®ãƒ‡ãƒ¼ã‚¿ã€è¨­å®šã€ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’æŒã¡ã¾ã™ãŒã€åŒã˜ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã¨ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚’å…±æœ‰ã—ã¾ã™ã€‚

## æ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

Next.js ã§ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹å ´åˆã€Vercel ãŒæä¾›ã™ã‚‹ **Platforms Starter Kit** ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‚ç…§ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

### Platforms Starter Kit

ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ï¼š

- **ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³**: å„ãƒ†ãƒŠãƒ³ãƒˆã«ç‹¬è‡ªã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®š
- **å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„**: ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„
- **ãƒ‡ãƒ¼ã‚¿åˆ†é›¢**: ãƒ†ãƒŠãƒ³ãƒˆé–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«åˆ†é›¢
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: å¤§è¦æ¨¡ãªãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚µãƒãƒ¼ãƒˆ

ğŸ”— **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆURL**: https://vercel.com/templates/next.js/platforms-starter-kit

## ä¸»è¦ãªè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥

#### ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹

```
tenant1.example.com
tenant2.example.com
tenant3.example.com
```

```typescript
// middleware.ts
import { NextRequest, NextResponse } from 'next/server'

export function middleware(request: NextRequest) {
  const hostname = request.headers.get('host') || ''
  const subdomain = hostname.split('.')[0]

  // ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«åŸºã¥ã„ã¦ãƒ†ãƒŠãƒ³ãƒˆã‚’è­˜åˆ¥
  const tenantId = subdomain

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ†ãƒŠãƒ³ãƒˆIDã‚’è¨­å®š
  const requestHeaders = new Headers(request.headers)
  requestHeaders.set('x-tenant-id', tenantId)

  return NextResponse.next({
    request: {
      headers: requestHeaders,
    },
  })
}
```

#### ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹

```
example.com/tenant1
example.com/tenant2
example.com/tenant3
```

```typescript
// app/[tenant]/page.tsx
export default async function TenantPage({
  params,
}: {
  params: { tenant: string }
}) {
  const tenantData = await getTenantData(params.tenant)

  return (
    <div>
      <h1>{tenantData.name}</h1>
      <p>{tenantData.description}</p>
    </div>
  )
}
```

#### ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³

```
tenant1.com
tenant2.com
custom-domain.com
```

### 2. ãƒ‡ãƒ¼ã‚¿åˆ†é›¢

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®è¨­è¨ˆ

ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã« `tenant_id` ã‚’å«ã‚ã‚‹ï¼š

```sql
CREATE TABLE posts (
  id UUID PRIMARY KEY,
  tenant_id UUID NOT NULL,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Š
CREATE INDEX idx_posts_tenant_id ON posts(tenant_id);
```

#### Row Level Securityï¼ˆRLSï¼‰

PostgreSQL ã® RLS ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ï¼š

```sql
-- RLS ã‚’æœ‰åŠ¹åŒ–
ALTER TABLE posts ENABLE ROW LEVEL SECURITY;

-- ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ
CREATE POLICY tenant_isolation_policy ON posts
  USING (tenant_id = current_setting('app.current_tenant_id')::uuid);
```

### 3. ãƒ†ãƒŠãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—

```typescript
// lib/tenant.ts
import { headers } from 'next/headers'

export async function getCurrentTenant() {
  const headersList = await headers()
  const tenantId = headersList.get('x-tenant-id')

  if (!tenantId) {
    throw new Error('Tenant ID not found')
  }

  const tenant = await db.tenant.findUnique({
    where: { id: tenantId },
  })

  return tenant
}
```

```typescript
// app/dashboard/page.tsx
import { getCurrentTenant } from '@/lib/tenant'

export default async function DashboardPage() {
  const tenant = await getCurrentTenant()

  return (
    <div>
      <h1>{tenant.name} ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      {/* ãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
    </div>
  )
}
```

### 4. ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã®ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°

```typescript
// lib/branding.ts
export async function getTenantBranding(tenantId: string) {
  const branding = await db.branding.findUnique({
    where: { tenantId },
  })

  return {
    primaryColor: branding.primaryColor || '#3B82F6',
    logo: branding.logo || '/default-logo.png',
    favicon: branding.favicon || '/favicon.ico',
  }
}
```

```typescript
// app/layout.tsx
import { getCurrentTenant } from '@/lib/tenant'
import { getTenantBranding } from '@/lib/branding'

export async function generateMetadata() {
  const tenant = await getCurrentTenant()
  const branding = await getTenantBranding(tenant.id)

  return {
    title: tenant.name,
    icons: {
      icon: branding.favicon,
    },
  }
}

export default async function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const tenant = await getCurrentTenant()
  const branding = await getTenantBranding(tenant.id)

  return (
    <html>
      <head>
        <style>{`
          :root {
            --primary-color: ${branding.primaryColor};
          }
        `}</style>
      </head>
      <body>{children}</body>
    </html>
  )
}
```

### 5. ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã®è¨­å®š

```typescript
// lib/config.ts
export interface TenantConfig {
  features: {
    analytics: boolean
    customDomain: boolean
    apiAccess: boolean
  }
  limits: {
    users: number
    storage: number // MB
    apiCalls: number // per month
  }
}

export async function getTenantConfig(tenantId: string): Promise<TenantConfig> {
  const config = await db.tenantConfig.findUnique({
    where: { tenantId },
  })

  return config
}
```

## å®Ÿè£…ä¾‹

### å®Œå…¨ãªãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå®Ÿè£…

```typescript
// middleware.ts
import { NextRequest, NextResponse } from 'next/server'

export function middleware(request: NextRequest) {
  const hostname = request.headers.get('host') || ''

  // ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã¾ãŸã¯ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å‡¦ç†
  let tenantId: string

  if (hostname.includes('.example.com')) {
    // ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³
    tenantId = hostname.split('.')[0]
  } else {
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§æ¤œç´¢
    // ã“ã®ä¾‹ã§ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ã€ãƒ›ã‚¹ãƒˆåã‚’ãã®ã¾ã¾ä½¿ç”¨
    tenantId = hostname
  }

  const requestHeaders = new Headers(request.headers)
  requestHeaders.set('x-tenant-id', tenantId)

  return NextResponse.next({
    request: {
      headers: requestHeaders,
    },
  })
}

export const config = {
  matcher: [
    '/((?!api|_next/static|_next/image|favicon.ico).*)',
  ],
}
```

```typescript
// lib/db.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = global as unknown as { prisma: PrismaClient }

export const prisma =
  globalForPrisma.prisma ||
  new PrismaClient({
    log: ['query'],
  })

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma

// ãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ã®ã‚¯ã‚¨ãƒªãƒ˜ãƒ«ãƒ‘ãƒ¼
export async function withTenant<T>(
  tenantId: string,
  callback: () => Promise<T>
): Promise<T> {
  // RLS ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
  await prisma.$executeRaw`SELECT set_config('app.current_tenant_id', ${tenantId}, false)`
  return callback()
}
```

```typescript
// app/posts/page.tsx
import { getCurrentTenant } from '@/lib/tenant'
import { prisma, withTenant } from '@/lib/db'

export default async function PostsPage() {
  const tenant = await getCurrentTenant()

  const posts = await withTenant(tenant.id, async () => {
    return prisma.post.findMany({
      where: {
        tenantId: tenant.id,
      },
      orderBy: {
        createdAt: 'desc',
      },
    })
  })

  return (
    <div>
      <h1>{tenant.name} ã®æŠ•ç¨¿</h1>
      <ul>
        {posts.map((post) => (
          <li key={post.id}>{post.title}</li>
        ))}
      </ul>
    </div>
  )
}
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **å¸¸ã«ãƒ†ãƒŠãƒ³ãƒˆIDã‚’æ¤œè¨¼**: ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãƒ†ãƒŠãƒ³ãƒˆIDã‚’ç¢ºèª
2. **Row Level Security ã‚’ä½¿ç”¨**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢
3. **èªè¨¼ã‚’å¼·åŒ–**: å„ãƒ†ãƒŠãƒ³ãƒˆã«é©åˆ‡ãªèªè¨¼ã‚’å®Ÿè£…
4. **ç›£æŸ»ãƒ­ã‚°**: ãƒ†ãƒŠãƒ³ãƒˆé–“ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨˜éŒ²
5. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ¶é™

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–

1. **ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°**: ãƒ†ãƒŠãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
2. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: `tenant_id` ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
3. **æ¥ç¶šãƒ—ãƒ¼ãƒªãƒ³ã‚°**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’åŠ¹ç‡çš„ã«ç®¡ç†
4. **CDN**: é™çš„ã‚¢ã‚»ãƒƒãƒˆã‚’CDNã§é…ä¿¡

## ã¾ã¨ã‚

ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹éš›ã®ä¸»è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š

1. **ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥**: ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ãƒ‘ã‚¹ã€ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³
2. **ãƒ‡ãƒ¼ã‚¿åˆ†é›¢**: Row Level Security ã¨ãƒ†ãƒŠãƒ³ãƒˆID
3. **ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°**: ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
4. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: å³æ ¼ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
5. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: åŠ¹ç‡çš„ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

è©³ç´°ãªå®Ÿè£…ä¾‹ã«ã¤ã„ã¦ã¯ã€[Platforms Starter Kit](https://vercel.com/templates/next.js/platforms-starter-kit) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
